<adventure>
    
   	<mapScript>
   	
	    <condition name="valori" locked="false">
	    	<!--  <spawn who="bitey" pos="220,118" type="BITEY"/> -->
	    	<perso who="bitey1" action="bitey"/> 
	    	<spawn who="scorp" pos="831, 717" type="SCORPION" floor="2" info="ENEMY"/>
	    	<perso who="scorp" action="scorpion"/>
	    	<visible who="pied1" value="false"/>
	    	<visible who="pied2" value="false"/>
	       	<visible who="pied3" value="false"/>
	       		       	
	       	<if expQuest="valori_key1">
	       		<tile pos="16,9" back2="256*5+150"/>
	       	</if>
	       	<if expQuest="valori_key2">
	       		<tile pos="18,8" back2="256*5+150"/>
	       	</if>
	       	<if expQuest="valori_key3">
	       		<tile pos="20,9" back2="256*5+150"/>
	       	</if>
	       	<!-- Element used to create a collision about tile which aren't usually -->
	       	<visible what="tohide1" value="false"/>
	       	<visible what="tohide2" value="false"/>
	       	<visible what="tohide3" value="false"/>
	       	<visible what="tohide4" value="false"/>
	       	<!-- Reveal secret pit if needed -->
	       	<if expQuest="valori_allKeys">
		       	<tile pos="28,3" back="256*6+86" back2="-1"/>
	   	        <tile pos="29,3" back="256*6+86" reverse="128" />
	   	        <tile pos="28,4" back="256*6+197" />
	   	        <tile pos="29,4" back="256*6+197" reverse="128" />
	       	</if>

	       	<perso who="taupe" action="mole"/>
	       	<perso who="taupe2" action="mole"/>
	       	<perso who="mole3" action="mole"/>
	       	<perso who="mole4" action="mole"/>
	       		       	
	    </condition>
    
	    <condition name="canyon" locked="false">
	    	<!-- Place catapult TODO: plan quest to set each catapult state -->
	    	<spawn what="catcrate1" pos="551,280" type="CATAPULT_CRATE"/>
	    	<spawn what="catbranch1" pos="551,280" reverse="128" z="3" type="CATAPULT_BRANCH"/>
	    	<spawn what="stone1" pos="566,281" type="STONE_HEAVY"/>
	    	
	    	<spawn what="catcrate2" pos="738,263" type="CATAPULT_CRATE"/>
	    	<spawn what="catbranch2" pos="738,263" reverse="128" z="3" type="CATAPULT_BRANCH"/>
	    	<spawn what="stone2" pos="753,264" type="STONE"/>
	    	
	    	<spawn what="catcrate3" pos="848,153" type="CATAPULT_CRATE"/>
	    	<spawn what="catbranch3" pos="848,153" reverse="0" z="3" type="CATAPULT_BRANCH"/>
	    	<spawn what="stone3" pos="833,154" type="STONE"/>
	    	
	    	<spawn what="catcrate4" pos="731,71" type="CATAPULT_CRATE"/>
	    	<spawn what="catbranch4" pos="731,71" reverse="128" z="3" type="CATAPULT_BRANCH"/>
	    	<spawn what="stone4" pos="746,72" type="STONE_HEAVY"/>
	    	
	    	<markQuest name="catap1" value="false"/>
	    	<markQuest name="catap2" value="false"/>
	    	<markQuest name="catap3" value="false"/>
	    	<markQuest name="catap4" value="false"/>
	    </condition> 
	    
	    <condition name="valorig">
	        <if expQuest="valorig_lever1">
	        	<activate what="doorRight" value="true" unblock="true"/>
	        </if>
	       	<if expQuest="valorig_lever2">
	        	<activate what="doorUp" value="true" unblock="true"/>
	        </if>
	        <perso who="scorp" action="scorpion"/>
	    </condition>
	    
	    <condition name="valorig2">
		    <spawn what="scepter" pos="208,99" type="SCEPTER"/>
	        <visible who="pano" value="false"/>
	    </condition>
	    
	    <condition name="prisonext" exp="findDragonPortalKey">
	        <!-- Epic battle -->
	        <remove who="gardenord"/>
	        <spawn who="black1" pos="349,221" type="GARDE_CANARD" info="ENEMY" angle="0" pv="4" effect="noir"/>
	        <spawn who="black2" pos="510,46" type="GARDE_CANARD" info="ENEMY" angle="3" pv="4" effect="noir"/>
	        <script who="black1" value="7"/>
	        <script who="black2" value="7"/>
	        <spawn who="thrower1" type="DARKGUY" floor="2" pos="267,178" info="ENEMY"/>
	        <spawn who="thrower2" type="DARKGUY" floor="2" pos="467,178" info="ENEMY"/>
	        <script who="thrower1" value="0"/>
	        <script who="thrower2" value="0"/>
	        <perso who="thrower1" action="darkGuy"/>
	        <perso who="thrower2" action="darkGuy"/>
	        <spawn who="black3" pos="347,280" type="GARDE_CANARD" info="ENEMY" angle="0" pv="4" effect="noir"/>
	        <spawn who="black4" pos="385,280" type="GARDE_CANARD" info="ENEMY" angle="0" pv="4" effect="noir"/>
	        <script who="black3" value="13"/>
	        <script who="black4" value="13"/>
	        <!-- Crates and immobile thrower 3 -->
			<spawn what="c1" type="CRATE" pos="210,353"/>
			<spawn what="c2" type="CRATE" pos="225,361"/>
			<spawn what="c3" type="CRATE2" pos="223,378"/>
			<spawn what="c4" type="CRATE" pos="236,394"/>
			<spawn what="c5" type="CRATE2" pos="192,347"/>
			<spawn who="thrower3" type="DARKGUY" pos="200,379" info="ENEMY"/>
			<perso who="thrower3" action="immobileDarkGuy"/>
			<!-- Crates and immobile thrower 4 -->
			<spawn what="c6" type="CRATE" pos="325,388"/>
			<spawn what="c7" type="CRATE" pos="340,380"/>
			<spawn what="c8" type="CRATE2" pos="363,378"/>
			<spawn what="c9" type="CRATE" pos="380,395"/>
			<spawn what="c10" type="CRATE2" pos="370,422"/>
			<spawn who="thrower4" type="DARKGUY" pos="356,398" info="ENEMY"/>
			<perso who="thrower4" action="immobileDarkGuy"/>
			
			<spawn who="fire" type="COAL_COLD" effect="fire" pos="363,330"/>
			<pos what="fire_f" pos="0,-3" delta="true"/>
			<spawn what="b1" type="BAGSAND" pos="306,293"/>
			<spawn what="b2" type="BAGSAND" pos="300,300" reverse="128"/>
			<spawn what="b3" type="BAGSAND" pos="290,310"/>
			<spawn what="b4" type="BAGSAND" pos="292,316"/>
			<!-- Line of bags -->
			<spawn type="BAGSAND" pos="377,488"/>
			<spawn type="BAGSAND" pos="360,489"/>
			<spawn type="BAGSAND" pos="343,486" reverse="128"/>
			<spawn type="BAGSAND" pos="330,484"/>
			<spawn type="BAGSAND" pos="315,490"/>
			<spawn type="BAGSAND" pos="300,487"/>
			<spawn type="BAGSAND" pos="290,490" reverse="128"/>
			<spawn type="BAGSAND" pos="272,488"/>
			<spawn type="BAGSAND" pos="259,483" reverse="128"/>
			<spawn type="BAGSAND" pos="242,491" reverse="128"/>
			<spawn type="BAGSAND" pos="220,488"/>
			<spawn type="BAGSAND" pos="205,486"/>
			<spawn type="BAGSAND" pos="190,483" reverse="128"/>
			<spawn type="BAGSAND" pos="175,484" reverse="128"/>
			
			<spawn who="black5" pos="635,313" type="GARDE_CANARD" info="ENEMY" angle="3" pv="4" effect="noir"/>
	        <script who="black5" value="7"/>
			<spawn who="black6" pos="640,329" type="GARDE_CANARD" info="ENEMY" angle="3" pv="4" effect="noir"/>
	        <script who="black6" value="7"/>
	        
	       	<spawn who="black7" pos="770,333" type="GARDE_CANARD" info="ENEMY" angle="3" pv="4" effect="noir"/>
	       	<script who="black7" value="0"/>
	        <spawn who="black8" pos="807,391" type="GARDE_CANARD" info="ENEMY" angle="3" pv="4" effect="noir"/>
	        <script who="black8" value="0"/>
	        
	        <spawn who="black9" pos="921,633" type="GARDE_CANARD" info="ENEMY" angle="3" pv="4" effect="noir"/>
	        <script who="black9" value="7"/>
	        
	       	<spawn who="black10" pos="500,789" type="GARDE_CANARD" info="ENEMY" angle="3" pv="4" effect="noir"/>
	        <script who="black10" value="0"/>
	        
	        <script who="gard2" value="0"/>
	        <script who="gard5" value="0"/>
	
	       	<tile pos="38,41" back2="561"/>
	        <if expQuest="prisonext(38, 41)">
			    <tile pos="38,41" back2="560"/>
	        </if>
	        <spawn type="GOLDPURSE1" pos="616,664" value="100"/>
	        
	     </condition>
	     
		<condition name="chateaucoucou1"  exp="findDragonPortalKey">
		    <remove who="gard3"/>
			<spawn type="BAGSAND" pos="464,173"/>
			<spawn type="BAGSAND" pos="476,176" reverse="128"/>
			<spawn type="BAGSAND" pos="488,172"/>
			<spawn type="BAGSAND" pos="500,174" reverse="128" />
			<spawn type="BAGSAND" pos="513,169" reverse="128"/>
			<spawn type="BAGSAND" pos="525,171"/>
		</condition>
		
		<condition name="chateaucoucou3">
		    <perso who="noir" pv="4"/>
		</condition>
		
		<condition name="chatcou6">
		    <perso who="noir" pv="4"/>
		</condition>
		
		<condition name="chatcou8">
		    <if expQuest="!killButcher">
			 	<perso who="butcher" action="butcher"/>
			 	<activate what="doorFirst" value="true" unblock="true"/>
			 	<music/>
			</if>
			<if expQuest="killButcher">
			     <remove who="butcher"/>
			     <activate what="exitDoor" value="true"/>
			     <remove what="doorFirst"/>
			</if>
		</condition>

   	</mapScript>

   	<quest name="prisonext">
   	    <trigger>
   	        <location name="prisonext"/>
   	        <questDone name="findDragonPortalKey" />
   	    </trigger>
   	    <action>
   	        <music/>
   	        <herospecial value="1"/> <!-- Block everybody -->
   	        
   	        <moveTo who="zildo" pos="0,48" delta="true"/>
   	        
   	        <!-- Place blocking invisible sprite to the only exit -->
   	        <spawn what="nopasaran" type="CAVE_SIMPLEDOOR" pos="369,28"/>
   	        <visible what="nopasaran" value="false"/>
	        <speak who="gard" text="pext.gardecatch1"/>
	        <herospecial value="11" arg="black1"/>
	        <herospecial value="11" arg="black2"/>
	        <sound name="MonstreTrouve"/>
	       	<speak who="gard" text="pext.gardecatch2"/>
	        <!-- <herospecial value="10" arg="402,93"/> -->
	        <herospecial value="2"/>
	        <music name="ChateauAttaque"/>
   	    </action>
   	    <history>
	        <zikReplace what="Chateau" name="ChateauAttaque"/>
   	    </history>
   	</quest>
   	
   	<quest name="visit_valori" locked="false">
   	    <trigger>
   	        <location name="valori"/>
   	    </trigger>
   	</quest>
   	
   	<quest name="charles_fork" locked="false">
   	    <trigger>
   	        <location name="ferme"/>
   	        <dialog name="charles" num="4"/>
   	        <questDone name="!laura_fork"/>
   	    </trigger>
   	    <action>
   	        <var name="allowedTakeFork" type="_string" value="yes"/>
   	        <sound name="ZildoAccomplishQuest"/>
   	    </action>
   	</quest>
   	<quest name="laura_fork" locked="false">
   	    <trigger>
   	        <location name="fermem1"/>
   	        <dialog name="laura" num="5"/>
   	        <questDone name="!charles_fork"/>
   	    </trigger>
   	    <action>
   	        <var name="allowedTakeFork" type="_string" value="yes"/>
   	        <sound name="ZildoAccomplishQuest"/>
   	    </action>
   	</quest>
   	
   	<quest name="squeak_bridge" locked="false" repeat="true">
	    <trigger>
	         <location name="valori" pos="749,743" floor="2"/>
	    </trigger>
	    <action>
	        <var name="loc:d" value="dice10"/>
	        <if exp="loc:d>5">
	        	<sound name="Squeak2"/>
	        </if>
	        <if exp="loc:d&lt;5">
	            <sound name="Squeak1"/>
	        </if>
	        <wait value="40"/>
	    </action>
   	</quest>
   		    
	<quest name="catap1" locked="false">
   	    <trigger>
   	        <location name="canyon" pos="452,338" radius="2"/>
   	    </trigger>
   	    <action>
   	        <exec script="vultureCatap(520, 184, 566-25, 281-8, 'stone1', 'catbranch1')"/>
   	    </action>
   	</quest>
   	
   	<quest name="catap2" locked="false">
   	    <trigger>
   	        <location name="canyon" pos="704,339" radius="2"/>
   	    </trigger>
   	    <action>
   	        <exec script="vultureCatap(710, 164, 753-25, 264-8, 'stone2', 'catbranch2')"/>
   	    </action>
   	</quest>
   	
   	<quest name="catap3" locked="false">
   	    <trigger>
   	        <location name="canyon" pos="790,263" radius="2"/>
   	    </trigger>
   	    <action>
   	        <exec script="vultureCatap(870, 68, 833-25+25+25, 154-8, 'stone3', 'catbranch3')"/>
   	    </action>
   	</quest>
   	
   	<quest name="catap4" locked="false">
   	    <trigger>
   	        <location name="canyon" pos="790,178" radius="2"/>
   	    </trigger>
   	    <action>
   	        <exec script="vultureCatap(711, 7, 746-25, 72-8, 'stone4', 'catbranch4')"/>
   	    </action>
   	</quest>

   	<quest name="valorig_lever1" locked="false">
	    <trigger>
	        <location name="valorig"/>
	        <tileattack tilePos="54,17"/>
	    </trigger>
	    <action>
	        <exec script="activeLever(54,17)"/>
	        <activate what="doorRight" value="true"/>
	    </action>
	</quest>   	    

   	<quest name="valorig_lever2" locked="false">
	    <trigger>
	        <location name="valorig"/>
	        <tileattack tilePos="38,4"/>
	    </trigger>
	    <action>
	        <exec script="activeLever(38,4)"/>
	        <activate what="doorUp" value="true"/>
	    </action>
	</quest>  
	
   	<quest name="valori_key1" locked="false">
   	    <trigger>
   	        <location name="valori"/>
   	        <dialog name="pied1" num="1"/>
   	    </trigger>
   	    <action>
   	        <exec script="insertPortalKey(16,9)"/>
   	    </action>
   	</quest> 
   	
   	<quest name="valori_key2" locked="false">
   	    <trigger>
   	        <location name="valori"/>
   	        <dialog name="pied2" num="1"/>
   	    </trigger>
   	    <action>
   	        <exec script="insertPortalKey(18,8)"/>
   	    </action>
   	</quest> 
   	
   	<quest name="valori_key3" locked="false">
   	    <trigger>
   	        <location name="valori"/>
   	        <dialog name="pied3" num="1"/>
   	    </trigger>
   	    <action>
   	        <exec script="insertPortalKey(20,9)"/>
   	    </action>
   	</quest>

   	<quest name="valori_allKeys">
   	    <trigger>
   	        <!-- 'pos' attribute is important to be sure that this quest is triggered AFTER all three others. It ensures player moves before triggering. -->
   	        <location name="valori" pos="291,151" radius="16"/>
   	        <questDone name="valori_key1-valori_key2-valori_key3"/>
   	    </trigger>
   	    <action>
   	        <music />
   	        <wait value="50"/>
   	        <moveTo what="camera" pos="300,0"/>
   	        <wait value="50"/>
   	        <sound name="ZildoPousse"/>
		   	<animation type="CLOUD_FOG" pos="450,72"/>

		   	<!-- Reveals secret pit -->
   	        <tile pos="28,3" back="256*6+86" back2="256*5+38"/>
   	        <tile pos="29,3" back="256*6+86" back2="256*5+38" reverse="128" />
   	        <tile pos="28,4" back="256*6+197" back2="256*5+38" />
   	        <tile pos="29,4" back="256*6+197" back2="256*5+38" reverse="128" />
   	        <wait value="10"/>
		   	<animation type="CLOUD_FOG" pos="476,64"/>
   	        <tile pos="28,4" back2="256*5+175" />
   	        <tile pos="29,4" back2="256*5+187" />
   	        <wait value="10"/>
   	        <tile pos="28,4" back2="256*5+185" />
   	        <tile pos="29,4" back2="256*5+185" />
   	        <wait value="10"/>
   	        <tile pos="28,3" back2="256*5+175" />
   	        <tile pos="29,3" back2="256*5+187" />
   	        <wait value="10"/>
   	        <tile pos="28,3" back2="256*5+185" />
   	        <tile pos="29,3" back2="256*5+185" />
   	        <tile pos="28,4" back2="-1" />
   	        <tile pos="29,4" back2="-1" />
   	        <wait value="10"/>
   	        <tile pos="28,3" back2="-1" />
   	        <tile pos="29,3" back2="-1" />
   	       	<wait value="50"/>
   	       	<sound name="ZildoSecret"/>
   	       	<animation type="STAR_SHINE" pos="465,58"/>
   	       	<wait value="200"/>
   	        <focus who="zildo" delta="true"/>
   	        <wait value="100"/>
   	        <music name="Valori"/>
   	    </action>
   	</quest>	

   	<!-- Disable chaining point if secret cave isn't revealed yet -->
   	<quest name="pitChaining" locked="false">
        <trigger>
            <location name="valori" pos="458,56" radius="2"/>
            <chainingPoint/>
            <questDone name="!valori_allKeys"/>                     
        </trigger>
        <action>
           	<markQuest name="pitChaining" value="false"/>
        </action>
    </quest>

   	<quest name="findScepter" locked="false">
   	    <trigger>
   	        <location name="valorig2"/>
   	        <dialog name="pano" num="0"/>
   	    </trigger>
   	    <action>
   	        <remove what="scepter"/>
   	        <take item="ITEM_SCEPTER"/>
   	    </action>
   	</quest>
   	
   	<quest name="killButcher">
   	    <trigger>
   	        <location name="chatcou8"/>
   	        <dead who="butcher"/>
   	    </trigger>
   	    <action>
   	        <focus what="exitDoor" delta="true" unblock="false"/>
   	        <activate what="exitDoor" value="true"/>
   	        <wait value="50"/>
   	        <focus who="zildo" delta="true"/>
   	        <wait value="100"/>
   	    </action>
   	</quest>

   	<quest name="enterAttackedCastle">
   	    <trigger>
   	        <location name="chateaucoucou1"/>
   	        <questDone name="findDragonPortalKey"/>
   	    </trigger>
   	    <action>
		    <wait value="60"/>
		    <moveTo who="zildo" pos="0,24" delta="true"/>
		    <speak who="zildo" text="chatcou.attaque"/>
		    <speak who="zildo" text="chatcou.attaque2"/>
   	    </action>
   	</quest>

   	<quest name="appearButcher">
   	    <trigger>
   	        <location name="chatcou8" pos="280,270" radius="6"/>
   	    </trigger>
   	    <action>
   	        <wait value="50"/>
   	        <moveTo what="camera" pos="80,-64" delta="true"/>
   	        <music name="Surprise"/>
   	        <wait value="50"/>
	        <activate what="doorFirst" value="false" unblock="true"/>
   	        <moveTo what="camera" pos="-80,64" delta="true"/>
   	    </action>
   	</quest>
   	
   	<scene id="insertPortalKey">
   		<putDown item="PORTAL_KEY"/>
   		<tile pos="loc:arg0,loc:arg1" back2="256*5+150"/>
   		<sound name="MoonFusion"/>
  	</scene>
   	
   	<scene id="intro_episode4">
   	    <wait value="30"/>
   	    <music/>
   	    <wait value="50"/>
   	    <map name="voleurs"/>
   	    <pos who="zildo" pos="79,377"/>
   	    <angle who="zildo" value="2"/>
   	    <script who="zildo" text="VIDE"/>
    	<speak what="camera" text="ep4.beginning.0"/>
      	<fadeIn value="0"/>
      	<wait value="100"/>
   	    <moveTo who="zildo" pos="0,24" delta="true"/>
   	    <wait value="20"/>
   	    <sound name="ZildoAttaque" pos="0,100"/>
   	    <angle who="zildo" value="3"/>
   	    <wait value="46"/>
   	    <sound name="ZildoAttaque" pos="20,10"/>
   	    <wait value="25"/>
   	    <sound name="MenuMove" pos="-20,10"/>
   	    <wait value="7"/>
   	    <sound name="ZildoAttaque" pos="-10,140"/>
   	    <wait value="14"/>
   	    <sound name="Explosion" pos="-60,50"/>
   	    <wait value="20"/>
   	    <sound name="ZildoAttaque" pos="0,50"/>
    	<speak what="camera" text="ep4.beginning.1"/>
   	    <sound name="ZildoAttaque" pos="-10,140"/>
    	<speak what="camera" text="ep4.beginning.2"/>
    	<speak who="synthe" text="info.episode4" unblock="true"/>
    	<music name="Nuit"/>
    </scene>
   		
   	<persoAction id="bitey">
        <loop>
            <var name="loc:found" value="0"/>
			<lookFor who="self" info="ZILDO" radius="7">
				<var name="loc:found" value="1"/>
			</lookFor>
			<actions>
				<if exp="loc:found=1">
				    <!-- Set angle and reverse -->
				    <actions>
					    <if exp="zildo.x &gt; x">
						    <perso who="self" reverse="128"/>
						    <angle who="self" value="1"/>
					    </if>
					    <if exp="zildo.x &lt; x">
						    <perso who="self" reverse="0"/>
						    <angle who="self" value="3"/>
					    </if>
				    </actions>
				    <!-- "Idle near" animation and bite if character is really close -->
		            <!-- Idle near -->
		            <seq who="self" addSpr="1,2,3,4,5,6,0,1,2" wait="4"/>
		            <sound name="WindNoLoop"/>
		            <!-- Extension to the victim -->
	            	<seq who="self" addSpr="11,12,13,14,15,16,17,18,19,20,21" wait="1"/>
	            	<actions>
		            	<if exp="angle=1">
							<spawn impact="GNAP" pos="x+55,y+4" reverse="128"/>	
		            	</if>
		            	<if exp="angle=3">
							<spawn impact="GNAP" pos="x-55,y+4"/>
						</if>
					</actions>	
	            	<sound name="Bitey"/>		    	
	            	<!-- Back to origin -->				    
	            	<seq who="self" addSpr="22,23,24,25,26,27" wait="1"/>
	            	<perso who="self" addSpr="28"/>
				</if>
				<if exp="loc:found=0">
			        <!-- Idle far -->
					<seq who="self" addSpr="7,8,9,10,9,8" wait="10"/>
				</if>
			</actions>
				        
        </loop>
   	</persoAction>
   	
   	<persoAction id="scorpion">
   	    <perso who="self" pv="4" flag="16"/>
   	    <loop>
   	        <var name="loc:found" value="1"/>
   	        <lookFor who="self" info="ZILDO" negative="true" radius="5">
   	            <!-- Hero is too far, move in a reduced zone -->
   	            <moveTo who="self" pos="x+random*20-10, y+random*20-10"/>
   	            <var name="loc:found" value="0"/>
   	        </lookFor>
   	        
   	        <if exp="loc:found=1">
   	            <!-- Move closer to hero, but not in his direction -->
   	            <moveTo who="self" pos="(3*x+zildo.x)/4, (y+zildo.y)/2"/>
   	            
   	            <if expQuest="!affSLOWNESS">
	   	            <!-- If hero isn't already affected, throw a poison ball with 2 followers -->
	   	            <sound name="SerpentSpit"/>
	   	            <var name="loc:zx" value="zildo.x"/>
	   	            <var name="loc:zy" value="zildo.y"/>
	   	            <var name="loc:r" value="0.5 + random*0.2"/>
	   	            <throw who="self" pos="x,y" to="loc:zx,loc:zy" 
					    type="POISONBALL" z="16" vz="loc:r" speed="1.5" az="-0.04"/>
					<wait value="1"/>	     
					<throw who="self" pos="x,y" to="loc:zx,loc:zy"
					    type="POISONBALL" z="16" vz="loc:r" speed="1.5" az="-0.04" alpha="127" />	        
					<wait value="1"/>	     
					<throw who="self" pos="x,y" to="loc:zx,loc:zy" 
					    type="POISONBALL" z="16" vz="loc:r" speed="1.5" az="-0.04" alpha="50" />	
   	            </if>
								    
				
	        </if>
   	    </loop>
   	</persoAction>
   	
   	<persoAction id="mole">

   	    <perso who="self" pv="2"/>	<!-- Speed should be initialized AFTER mouvement 23 -->
   	    <spawn who="loc:m2" type="MOLE" info="ENEMY" pos="x,y-5" alpha="255" speed="1" />
       	<spawn who="loc:m3" type="MOLE" info="ENEMY" pos="x,y-10" alpha="255" speed="1"/>
       	<spawn who="loc:m4" type="MOLE" info="ENEMY" pos="x,y-15" alpha="255" speed="1"/>

       	<loop>
			<!-- Bury -->
	   	    <script who="self" value="23"/>
   	    	<perso who="self" speed="1" flag="9" alpha="255" addSpr="2"/>	<!-- Speed should be initialized AFTER mouvement 23 -->
	   	    <perso who="loc:m2" parent="self" flag="12" addSpr="2" />
	       	<perso who="loc:m3" parent="self" flag="12" addSpr="2" zoom="200" />
	       	<perso who="loc:m4" parent="self" flag="12" addSpr="2" zoom="160" />
	   		<script who="loc:m2" value="22" effect="self"/>
	       	<script who="loc:m3" value="22" effect="loc:m2"/>
	       	<script who="loc:m4" value="22" effect="loc:m3"/>
	   	    <exec script="rotate(*loc:m2,1.0)" unblock="true" />
	   	    <exec script="rotate(*loc:m3)" unblock="true" />
	   	    <exec script="rotate(*loc:m4)" unblock="true" />
	   	    <!-- 
       		<perso who="self" flag="2"/>	 Should propagate 'immaterial' to every sprites of the mole -->
       		   		       			
			<!-- Move around hero (if he's not too far away) -->
			<var name="loc:dx" value="8"/>
			<if exp="zildo.x > x">
			    <var name="loc:dx" value="1.8*(zildo.x-x) min 50"/>
			</if>
       		<moveTo who="self" pos="loc:dx,0" delta="true"/>
       		<wait value="10"/>
       		<var name="loc:dy" value="8"/>
			<if exp="zildo.y > y">
			    <var name="loc:dy" value="(random*5+1.8*(zildo.y-y)) min 50"/>
			</if>
			<moveTo who="self" pos="0,loc:dy" delta="true" />
       		<wait value="10"/>
       		<var name="loc:dx" value="8"/>
			<if exp="x > zildo.x">
			    <var name="loc:dx" value="1.8*(x-zildo.x) min 50"/>
			</if>
			<moveTo who="self" pos="-loc:dx,0" delta="true" />
       		<wait value="10"/>
       		<var name="loc:dy" value="-8"/>
			<if exp="y > zildo.y">
			    <var name="loc:dy" value="1.8*(y-zildo.y) min 50"/>
			</if>
			<moveTo who="self" pos="0,-loc:dy" delta="true" />
       		<wait value="10"/>
       		
       		<!-- Stop rotate scripts -->
       		<stop script="rotate(*loc:m2,1.0)"/>
       		<stop script="rotate(*loc:m3)"/>
       		<stop script="rotate(*loc:m4)"/>

       		<!-- Popping out -->
       		<sound name="MoleOut" pos="x,y"/>
       		<!--  1) hole (m4) -->
       		<actions>
       		    <perso who="self" alpha="0"/> 
       		    <perso who="loc:m2" alpha="0"/>
	       		<perso who="loc:m3" alpha="0"/>
	       		<script who="loc:m4" value="3"/>
	       		<perso who="loc:m4" zoom="255" rotation="0" alpha="255" addSpr="4"/>
	       		<pos who="loc:m4" pos="x,y-1"/>
	       		<script who="self" value="3"/>
	       		<script who="loc:m2" value="3"/>
	       		<script who="loc:m3" value="3"/>
       		</actions>
       		<wait value="10"/>
       		<!-- 2) claws -->
       		<pos who="loc:m2" pos="x-7,y+2"/>
       		<pos who="loc:m3" pos="x+6,y+2"/>
       		<perso who="loc:m2" flag="4" alpha="255" addSpr="0" zoom="255" rotation="0"/>
       		<perso who="loc:m3" flag="4" alpha="255" addSpr="0" zoom="255" rotation="0" reverse="128"/>
       		<wait value="8"/>
       		<exec script="popSand(x-3,y)"/>
       		<exec script="popSand(x+3,y)"/>
       		<!-- 3) head -->
       		<actions>
       		    <perso who="loc:m4" alpha="0"/>
	       		<perso who="self" flag="0" alpha="255" addSpr="5"/>
			</actions>
       		<wait value="2"/>
       		<pos who="self" pos="x,y-1"/>
       		<wait value="1"/>
       		<pos who="self" pos="x,y-1"/>
       		<wait value="1"/>
       		<pos who="self" pos="x,y-2"/>
       		<wait value="2"/>
       		<perso who="self" addSpr="6"/>
       		<wait value="3"/>
       		<actions>
       		    <pos who="self" pos="x,y+4"/>
       			<perso who="self" flag="0" alpha="255" addSpr="1"/>
       		</actions>
			<wait value="10"/>
       		<!-- Attack -->
       		<sound name="MoleCry" pos="x,y"/>
       		<perso who="self" alpha="255" addSpr="3"/>
       		<wait value="20"/>
       		<perso who="self" addSpr="1"/>
       		<wait value="20"/>
       		
       		<!-- Head lower -->
       		<actions>
       			<perso who="self" addSpr="6"/>
       			<pos who="loc:m2" pos="x-4,y+2"/>
       			<pos who="loc:m3" pos="x+3,y+2"/>
       		</actions>
   			<wait value="3"/>
       		
       		<!-- Prepare to bury -->
       		<actions>
	       		<perso who="self" alpha="0"/>
	       		<perso who="loc:m2" addSpr="2" flag="12" alpha="255"/>
		       	<perso who="loc:m3" addSpr="2" flag="12" alpha="255"/>
		       	<perso who="loc:m4" addSpr="2" flag="12" alpha="255"/>
		       	<pos who="loc:m2" pos="x,y"/>
		       	<pos who="loc:m3" pos="x,y"/>
		       	<pos who="loc:m4" pos="x,y"/>
		    </actions>
   			<wait value="2"/>
       		<perso who="loc:m4" alpha="0"/>
       		<perso who="self" addSpr="2" flag="5"/>
			<wait value="2"/>

		</loop>
   	</persoAction>
   	
   	<persoAction id="darkGuy">
   	    <loop>
   	        <lookFor who="self" info="ZILDO" radius="7" changeContext="false">
   	            <!-- Determine a spot to throw dynamite -->
   	            <if exp="fun:mapFloor(zildo.x,zildo.y)=zildo.floor">
	   	            <sound name="ZildoLance"/>
	   	            <script who="self" value="3"/>	<!-- Stop -->
	   	            
	   	            <throw who="self" way="BELL" floor="2" pos="x,y" to="zildo.x,zildo.y" fx="0.01" fy="0.01" z="16" speed="1.5" az="-0.04" type="DYNAMITE"/>
	   	            <wait value="80"/>
	   	            <script who="self" value="0"/>
	   	                
   	            </if>
  	        </lookFor>
			<wait value="100"/>
   	    </loop>
   	</persoAction>
   	
   	<persoAction id="immobileDarkGuy">
   	    <script who="self" value="3"/>	<!-- Stop -->
   	    <loop>
   	        <lookFor who="self" info="ZILDO" radius="7" changeContext="false">
   	            <!-- Determine a spot to throw dynamite -->
   	            <sound name="ZildoLance"/>
   	            
   	            <throw who="self" way="BELL" floor="2" pos="x,y" to="zildo.x,zildo.y" fx="0.01" fy="0.01" z="16" speed="1.5" az="-0.04" type="DYNAMITE"/>
   	            <wait value="80"/>
  	        </lookFor>
			<wait value="100"/>
   	    </loop>
   	</persoAction>

   	<persoAction id="butcher">

   	    <!-- If distance from Zildo is too low, he tries to go back.
   	    So he picks 3 locations on a circle whom he's the center.
   	    Each one are on PI/2 quarters, starting from Zildo's axis (between him and hero).
   	    We take the first one available, free from collision.
   	    He has to be faster than hero.
   	    At a given time, he throws his hook on hero -->
   	    <perso who="self" pv="8"/> 
   	    <loop>
   	        <script who="self" value="3"/>
   	  		<perso who="self" speed="2.5"/>
			<lookFor who="zildo" radius="5" changeContext="false">
			    <!-- Get him away from hero -->
			    <!-- 
			    <moveTo pos="quarter(self, zildo, 7)"/>
			    
			    <var name="alpha" val="angle(self, zildo)"/>
			    <var name="loc1" val="project(self, alpha, 7)"/>
			    <var name="loc2" val="project(self, alpha+PI/2, 7)"/>
			    <var name="loc2" val="project(self, alpha+3*PI/2, 7)"/>
			    -->
			    
			    <var name="loc:iota" value="fun:angle(self, zildo)"/>
			    <var name="loc:attemptsLeft" value="4.0"/>
			    <var name="loc:fleeDistance" value="8*16"/>
			    <loop when="loc:attemptsLeft>0 &amp; loc:fleeDistance>0">
			        <var name="loc:iota" value="loc:iota + PI/2"/>
			   		<var name="loc:freeLoc" value="fun:project(self, loc:iota, 64.0)"/>
			   		<!-- If target location is reachable, go for it -->
			   		<if exp="fun:collide(loc:freeLoc)=0.0 &amp; fun:dist(loc:freeLoc, zildo.loc) > loc:fleeDistance &amp; fun:lineCollide(zildo.loc, loc:freeLoc)=0">
			   		    <moveTo who="self" pos="loc:freeLoc" skippable="true"/>
			   		    <var name="loc:attemptsLeft" value="0.0"/>"
			   		</if>
			   		<var name="loc:attemptsLeft" value="loc:attemptsLeft - 1"/>
			   		<if exp="loc:attemptsLeft=0">
			   		    <var name="loc:attemptsLeft" value="4.0"/>
			   		    <var name="loc:fleeDistance" value="loc:fleeDistance-16"/>
			   		</if>
			    </loop>

	   		</lookFor>
	   		<!-- He should face hero and throw his hook on him -->
	   		<script who="self" value="2"/>
	   		<wait value="10"/>
	   		
	   		<var name="loc:okForThrow" value="fun:lineCollide(x, y, zildo.x, zildo.y)=0"/>
	   		
	   		<if exp="loc:okForThrow=1">
	   		    <var name="loc:l" value="fun:loc(x,y)"/>
	   		    <var name="loc:okForThrow" value="fun:dist(loc:l, zildo.loc) &lt; (8*16-8)"/>
	   		</if>
	   		
	   		<if exp="loc:okForThrow=1">
		   		<!-- Throw hook at fixed location, standing still-->
		   		<var name="loc:zx" value="zildo.x"/>
		   		<var name="loc:zy" value="zildo.y"/>
		   		<script who="self" value="2"/>		<!-- Sight on hero -->
		   		<script who="self" value="3"/>		<!-- Stand still -->
		   		<throw who="self" what="loc:hook" pos="x,y" to="loc:zx,loc:zy" speed="2.6" type="HOOK" foreground="true"/>
		   		
		   		<!-- Create a chain outside of the for loop, to avoid local variable destroyed after for -->
		   		<throw who="self" what="loc:chain" pos="x,y" to="loc:zx,loc:zy" speed="2.6" type="HOOKCHAIN" foreground="true"/>
		   		
		   		<var name="loc:chainFinish" value="0"/>
		   		<sound name="Chain"/>
		   		<sprite what="loc:hook" fallScene="chainGoBack(*loc:hook, *loc:chain, x, y, *loc:chainFinish)"/>   	 
	
	
		   		<for var="loc:i" value="20">
		   		    <!-- Each chain elements will have the same name => easy to track and command -->
		   		    <if exp="loc:chainFinish=0">	<!-- Interrupt throw if the chain has already hit something -->
				    	<throw who="self" what="loc:chain" pos="x,y-1+random*3" to="loc:zx,loc:zy" speed="2.6" type="HOOKCHAIN"/>
				    	<throw who="self" what="loc:chain" pos="x,y-1+random*3" to="loc:zx,loc:zy" speed="2.6" type="HOOKCHAIN"/>
		   		    </if>	    
		   		</for>
				<!-- pull back chain if not yet -->
		   		<if exp="loc:chainFinish = 0">
		   		    <exec script="chainGoBack(*loc:hook, *loc:chain, x, y, *loc:chainFinish)"/>
		   		</if>
		   		<wait value="10"/>
		   		    
	   		</if>
	   		
   		</loop>
   	</persoAction>
   	
   	<scene id="chainGoBack">	<!-- arg0:hook sprite, arg1:chain sprite, arg2-arg3: hero coordinates, arg4:flag to notify chain is entirely back -->
   	    <if expQuest="E#loc:arg0">
   	        <!-- make hook return if it still exists -->
	  	    <var name="loc:arg4" value="1"/>
	  	    <actions>
			   	<moveTo what="loc:arg1" way="straight" speed="2.8" pos="loc:arg2,loc:arg3"/>
			   	<moveTo what="loc:arg0" way="straight" speed="2.8" pos="loc:arg2,loc:arg3" />
			</actions>
		   	<actions>
		 	   	<var name="loc:arg4" value="2"/>
		   	    <remove what="loc:arg0"/>
		   	    <remove what="loc:arg1"/>
		   	</actions>
		    <sound name="Chain" mute="true"/>
	   	</if>
   	</scene>
   	
   	<!-- Rotate a mole sprite named loc:arg0, doing sound if loc:arg1 is set to 1 -->
   	<scene id="rotate">
   	    <loop>
   	        <if exp="loc:arg1=1.0">
   	        	<sound name="MoleBuried1" pos="x,y"/>
   	        </if>
   	        <perso who="loc:arg0" rotation="0"/>
   	        <wait value="4"/>
   	        <exec script="popSand(x,y)"/>
   	        <perso who="loc:arg0" rotation="1"/>
   	        <wait value="4"/>
   	        <if exp="loc:arg1=1">
   	        	<sound name="MoleBuried2" pos="x,y"/>
   	        </if>
   	        <perso who="loc:arg0" rotation="2"/>
   	        <wait value="4"/>
       	    <exec script="popSand(x,y)"/>
       	    <perso who="loc:arg0" rotation="3"/>
   	        <wait value="4"/>
   	    </loop>
   	</scene>
   	
   	<scene id="popSand">
   	    <spawn impact="SAND_POPOUT" zoom="127+random*127" reverse="dice10>5:0,128" pos="loc:arg0,loc:arg1" />
   	</scene>	
   	
    <scene id="vultureCatap">
        <!-- (arg0,arg1) origin of vulture -->
        <!-- (arg2,arg3) location of the vulture's target -->
        <!-- arg4: stone ; arg5: branch -->
		<spawn who="loc:vulture" pos="loc:arg0,loc:arg1" type="VAUTOUR" info="ENEMY"/>
		<script who="loc:vulture" value="21" />
		<moveTo who="loc:vulture" z="30" pos="loc:arg2,loc:arg3"/>
		<wait value="10"/>
		<!-- 
		<moveTo what="loc:arg4" pos="0,0" delta="true" unstoppable="true"/>
		-->
       	<moveTo who="loc:vulture" speed="3" z="6"/>
       	<sound name="FlechePlante" />
       	<if exp="loc:arg0 &lt; loc:arg2"> <!-- Rock jumps to the right -->
	       	<actions>
				<sprite what="loc:arg4" vy="1" vx="0.4+random*0.3" az="-0.08" vz="2.8" z="4"/>   	       	    
		       	<sprite what="loc:arg5" reverse="0"/>
	       	</actions>
       	</if>
       	<if exp="loc:arg0 &gt; loc:arg2">
	       	<actions>
				<sprite what="loc:arg4" vy="1" vx="-0.4-random*0.3" az="-0.08" vz="2.8" z="4"/>   	       	    
		       	<sprite what="loc:arg5" reverse="128"/>
	       	</actions>
       	</if>
       	<moveTo who="loc:vulture" speed="1.5" z="0"/>
       	<wait value="5"/>
       	<moveTo who="loc:vulture" speed="2" pos="loc:arg0,-20" z="20" unblock="true"/>
       	<sprite what="loc:arg4" reverse="64"/>
       	<wait value="20"/>
       	<sprite what="loc:arg4" reverse="0"/>
       	<wait value="100"/>
       	<remove who="loc:vulture"/>
    </scene>
    
    <!-- Takes 4 parameters pos(arg0, arg1) where straw is thrown, and speed(arg2, arg3) indicating direction -->
    <scene id="throwStraw">
        <sound name="CasseBuisson" />
        <for var="loc:i" value="8">
            <spawn what="loc:s" type="dice10>4:STRAWF1,dice10>6:STRAWF2,STRAWF3" pos="loc:arg0,loc:arg1" 
                   z="5+random*11"
                   shadow="SHADOW_MINUS"
                   vx="-0.8+0.2 * loc:i + loc:arg2*0.6*random"
                   vy="loc:arg3*0.1*random" 
                   vz="-0.1+random*0.05" fx="0.1" alphaA="-0.1" 
                   reverse="dice10>5:0,128"/>
            <if expQuest="dice10>8">
                <sprite what="loc:s" alphaA="0"/>
            </if>
        </for>
    </scene>
</adventure>
