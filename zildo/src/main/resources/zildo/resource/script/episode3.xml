<adventure>

	<quest name="roxyMeetIsidore">
		<trigger>
			<location name="sousbois1" pos="423,632" radius="2"/> <!--  tile:25,39 -->
		</trigger>
		<action>
			<exec script="meetIsidore"/>
		</action>
	</quest>
	
	<!-- If this quest is done, hero would appear as a squirrel -->
	<quest name="hero_princess">
		<history>
			<herospecial value="6"/>
		</history>
	</quest>
	
	<quest name="removeNailForMoonStone">
		<trigger>
			<location name="sousbois3" tilePos="12,32" immediate="false"/>
			<fall type="PRINCESS_BUNNY" nature="REGULAR"/>
		</trigger>
		<action>
			<tile pos="12,32" back="174"/>
			<wait value="20"/>
			<tile pos="11,28" back2="-1"/>
			<tile pos="12,28" back2="-1"/>
			<animation pos="12*16,29*16" type="CLOUD_FOG" />
			<sound name="ZildoAccomplishQuest"/>
		</action>
	</quest>
	
	<quest name="sousbois3(20, 36)">
	    <action>
	        <markQuest name="removeNailForMoonStone" value="true"/>
	    </action>
	</quest>
	
	<!-- Will'o'wist quests -->
	<quest name="wow_1" locked="false">
		<trigger>
			<location name="sousbois4"/>
			<dialog name="neptune" num="1"/>
		</trigger>
	</quest>
	
	<quest name="wow_2" locked="false">
		<trigger>
			<location name="sousbois4"/>
			<dialog name="arsinoe" num="1"/>
		</trigger>
	</quest>
	
	<quest name="wow_3" locked="false">
		<trigger>
			<location name="sousbois4"/>
			<dialog name="porphyre" num="2"/>
		</trigger>
	</quest>
	
	<quest name="wow_4" locked="false">
		<trigger>
			<location name="sousbois4"/>
			<dialog name="archibald" num="2"/>
		</trigger>
	</quest>

   <!-- Detects 3 jumps on the stump. Quests need to be declared in reverse order, to avoid a chain triggering in the same frame. -->
	<quest name="jump_stumpNature3">
		<trigger>
			<location name="sousbois6" pos="831,187" radius="1" immediate="false"/>
			<questDone name="jump_stumpNature2"/>
			<fall type="PRINCESS_BUNNY" nature="REGULAR"/>
		</trigger>
		<action>
			<exec script="openNatureRoxy"/>
		</action>
	</quest>
	<quest name="jump_stumpNature2" locked="false">
		<trigger>
			<location name="sousbois6" pos="831,187" radius="1" immediate="false"/>
			<questDone name="jump_stumpNature1"/>
			<fall type="PRINCESS_BUNNY" nature="REGULAR"/>
		</trigger>
	</quest>
	<quest name="jump_stumpNature1" locked="false" >
		<trigger>
			<location name="sousbois6" pos="831,187" radius="1" immediate="false"/>
			<questDone name="jump_stumpNatureReady"/>
			<fall type="PRINCESS_BUNNY" nature="REGULAR"/>
		</trigger>
	</quest>
	
	
	<quest name="goOnStump" locked="false" repeat="true">
		<trigger>
			<location name="sousbois6" pos="831,187" radius="1" immediate="false"/>
			<fall type="PRINCESS_BUNNY" nature="REGULAR"/>
		</trigger>
		<action>
			<exec script="checkWillOWist"/>
		</action>
	</quest>

	<!-- Roxy discovers the ruin from the other side -->
	<quest name="sousbois4">
	    <trigger>
	        <location name="sousbois4" pos="645,648" radius="3"/>
	        <questDone name="!sousbois4_left"/>
	    </trigger>
	    <action>
	    	<exec script="discoverNatureRuin"/>
	    </action>
	</quest>
	<quest name="sousbois4_left">
	    <trigger>
	        <location name="sousbois4" pos="278,663" radius="3"/>
	        <questDone name="!sousbois4"/>
	    </trigger>
	    <action>
	        <wait value="30"/>
	        <angle who="zildo" value="1"/>
	        <wait value="30"/>
	        <moveTo who="zildo" pos="428,660"/>
	    	<exec script="discoverNatureRuin"/>
	    </action>
	</quest>

	<quest name="sousbois4SeeFireflies">
		<trigger>
		    <location name="sousbois4" pos="286,207" radius="2"/>
		</trigger>
		<action>
		    <moveTo who="zildo" pos="375,269"/>
		    <wait value="40"/>
		    <angle who="zildo" value="0"/>
		    <wait value="30"/>
		    <angle who="zildo" value="1"/>
		    <wait value="30"/>
		    <speak who="zildo" text="sousbois4.roxy.meet.0"/>
		    <speak who="zildo" text="sousbois4.roxy.meet.1"/>
		</action>
	</quest>
	
	<quest name="sousbois2_blueRain" locked="false">
	    <trigger>
	        <location name="sousbois2" tilePos="20,6"/>
	    </trigger>
	    <action>
	        <take item="BLUEDROP"/>
	        <wait value="50"/>
	        <markQuest name="sousbois2_blueRain" value="false"/>
	    </action>
	</quest>
	
	<quest name="killGard1" locked="false">
	    <trigger>
	        <location name="prison8"/>
	        <dead who="noirg"/>
	    </trigger>
	    <action>
	        <activate what="door" value="true"/>
	    </action>
	</quest>
	
	<quest name="isKillGard1">
	    <trigger>
		    <location name="prison8"/>
		    <questDone name="killGard1"/>
	    </trigger>
	    <action>
	        <activate what="door" value="true"/>
	    </action>
	</quest>
	
	<quest name="prison10Button" locked="false">
		<trigger>
		    <location name="prison10" tilePos="17,23" gear="BUTTON"/>
		</trigger>
	</quest>
	
	<quest name="prison12Locked" locked="false">
	    <trigger>
	        <location name="prison12"/>
	        <dead who="noir1,noir2"/>
	    </trigger>
	    <action>
	        <activate what="locked" value="true"/>
	    </action>
	</quest>
	
	<quest name="boss_turret">
	    <trigger>
	        <location name="prison14"/>
	    </trigger>
	    <action>
	        <!-- Make hero inside, close the door, and let's play boss music ! -->
	        <music name="Voleurs"/>
	        <wait value="40"/>
	        <moveTo who="zildo" pos="0,40" delta="true"/>
	        <activate what="doorUp" value="false"/>
	        <!-- Delegate to another quest, with 'locked' attribute at false to unlock player -->
	        <markQuest name="fightBossTurret1" value="true"/>
   	    </action>
	</quest>

	<quest name="fightBossTurret1" locked="false">
	    <action>
			<!-- Let the boss fight -->
	    	<exec script="spawnBossTurret1" unblock="true"/>
	    </action>
	</quest>
		
	<quest name="killBossTurret1" locked="false">
	    <trigger>
	        <location name="prison14"/>
	        <dead who="turretH"/>
	    </trigger>
	    <action>
	        <var name="bossFighting" value="0"/>
	        
	        <stop script="spawnBossTurret1"/>
	        <perso who="turret0" action=""/>
   	        <perso who="turretH" action=""/>
	       	<perso who="turret1" action=""/>
	        <perso who="turret2" action=""/>
	        <perso who="turret3" action=""/>
	        <perso who="turret4" action=""/>
	        
   	        <perso who="turretH" action="explodeBoss"/>
	       	<perso who="turret1" action="explodeBoss"/>
	        <perso who="turret2" action="explodeBoss"/>
	        <perso who="turret3" action="explodeBoss"/>
	        <perso who="turret4" action="explodeBoss"/>
	        
	        <wait value="20"/>
	        <remove type="TURRET_HEART"/>
	        <remove type="TURRET"/>
	        
	        <wait value="100"/>
	        <activate what="doorDown" value="true"/>
	        <activate what="doorUp" value="true"/>
	       	<animation type="BLUE_DROP" pos="164, 125" angle="1"/>
	       	<music name=""/>
	    </action>
	</quest>
	
	<!-- Prison 15 staffs launcher -->
	<quest name="prison15_trigger1Launch1" locked="false">
	    <trigger> <location name="prison15" pos="159,120" radius="1"/> </trigger>
	    <action> <exec script="prison15_launch1"/> </action>
	</quest>
	<quest name="prison15_trigger2Launch1" locked="false">
	    <trigger> <location name="prison15" pos="319,186" radius="1"/> </trigger>
	    <action> <exec script="prison15_launch1"/> </action>
	</quest>
		
	<quest name="prison15_trigger1Launch2" locked="false">
	    <trigger> <location name="prison15" pos="319,248" radius="1"/> </trigger>
	    <action> <exec script="prison15_launch2"/></action>
	</quest>
	<quest name="prison15_trigger2Launch2" locked="false">
	    <trigger> <location name="prison15" pos="56,314" radius="1"/> </trigger>
	    <action> <exec script="prison15_launch2"/> </action>
	</quest>
	
	<quest name="prison15_trigger1Launch3" locked="false">
	    <trigger> <location name="prison15" pos="159,438" radius="1"/> </trigger>
	    <action> <exec script="prison15_launch3"/></action>
	</quest>
	<quest name="prison15_trigger2Launch3" locked="false">
	    <trigger> <location name="prison15" pos="159,504" radius="1"/> </trigger>
	    <action> <exec script="prison15_launch3"/> </action>
	</quest>
	
	<quest name="prison15_trigger1Launch4" locked="false">
	    <trigger> <location name="prison15" pos="159,582" radius="1"/> </trigger>
	    <action> <exec script="prison15_launch4"/></action>
	</quest>
	<quest name="prison15_trigger2Launch4" locked="false">
	    <trigger> <location name="prison15" pos="159,648" radius="1"/> </trigger>
	    <action> <exec script="prison15_launch4"/> </action>
	</quest>
	
	<quest name="prison15Interrogation">
	    <trigger>
	        <location name="prison15" pos="158,46" radius="5"/>
	    </trigger>
	    <action>
	        <moveTo who="zildo" pos="159,63"/>
	        <wait value="30"/>
	        <angle who="zildo" value="3"/>
	        <wait value="20"/>
	        <angle who="zildo" value="1"/>
	        <wait value="30"/>
	        <speak who="zildo" text="prison16.zildo.0"/>
	        <angle who="zildo" value="2"/>
	        <speak who="zildo" text="prison16.zildo.1"/>
	    </action>
	</quest>
	
	<quest name="metKingPrison">
	    <trigger>
	        <location name="prison17"/>
	    </trigger>
	    <action>
	        <exec script="meetingKingPrison"/>
	    </action>
	</quest>
	
	<quest name="killKingGuards" locked="false">
	    <trigger>
	        <location name="prison16"/>
	        <dead who="noir1,noir2"/>
	    </trigger>
	</quest>
	
	<quest name="metKingPrison2">
	    <trigger>
	        <location name="prison17" pos="240,74" radius="2"/>
	        <questDone name="metKingPrison"/>
	    </trigger>
	    <action>
	        <exec script="meetingKingPrisonSuite"/>
	    </action>
	</quest>
	
	<quest name="metKingPrison3">
	    <trigger>
	        <location name="prison17" pos="240,74" radius="2"/>
	        <questDone name="metKingPrison2"/>
	    </trigger>
	    <action>
	        <exec script="meetingKingPrisonIllness"/>
	    </action>
	</quest>
	
	<quest name="getMidSword" locked="false">
	    <trigger>
	        <location name="d4m9"/>
	        <questDone name="jump_stumpNature3"/>
	        <dialog name="igor" num="1"/>
	    </trigger>
	    <action>
	        <take item="midsword"/>
	    </action>
	</quest>
	
	<quest name="meetEleo" locked="false">
	    <trigger>
	        <location name="eleom1"/>
	        <dialog name="eleoric" num="0"/>
	    </trigger>
	</quest>
	
	<quest name="eleoSpeak" locked="false">
	    <trigger>
	        <location name="eleom1"/>
	        <dialog name="eleoric" num="2"/>
	    </trigger>
	    <action>
	        <wait value="1000"/>
	        <markQuest name="eleoWaitForVacto" value="true"/>
	    </action>
	</quest>

	<quest name="eleoWaitForVacto">
	    <action>
	        <!-- TODO: we must be sure that hero isn't dialoguing ==> BUG ! -->
	        <exec script="vactoComeIn"/>
	    </action>
	</quest>
	<quest name="startGatherNettle" locked="false">
	    <trigger>
	        <dialog name="eleoric" num="6"/>
	    </trigger>
	    <action>
	        <herospecial value="8" arg="0"/>
	        <sound name="ZildoAccomplishQuest"/>
	    </action>
	</quest>
	
	<quest name="eleog(13, 3)" locked="false">
        <!-- When the hero explodes the wall in the cave, we set the other one, on farm's side opened -->
        <action>
            <sound name="ZildoSecret"/>
            <markQuest name="ferme(15, 59)" value="true"/>
        </action>
    </quest>
	
	<quest name="secretEleog">
		<trigger>
		    <location name="eleog"/>
		    <dead who="fire1,fire2"/>
		</trigger>	    
		<action>
		    <activate what="door" value="true"/>
		    <sound name="ZildoSecret"/>
		</action>
	</quest>
	
	<quest name="completeNettle1" locked="false"> <!-- Just for sound -->
	    <trigger>
	        <location name="eleom1"/>
	        <dialog name="eleoric" num="7"/>
	    </trigger>
	    <action>
	        <sound name="ZildoAccomplishQuest"/>
	    </action>
	</quest>
	
	<quest name="completeNettle2"> <!-- Remove nettle count -->
	    <trigger>
	        <location name="eleom1"/>
	        <dialog name="eleoric" num="8"/>
	    </trigger>
	    <action>
	        <herospecial value="8" arg="-1"/>
	        <exec script="EleoPrepareAntidote"/>
	    </action>
	</quest>

	<quest name="giveAntidote" locked="false">
	    <trigger>
	        <location name="eleom1"/>
	        <dialog name="eleoric" num="9"/>
	    </trigger>
	    <action>
	        <take item="CUREPOTION"/>
	    </action>
	</quest>
	
	<quest name="vactoTriste" locked="false">
	    <trigger>
	        <location name="eleom3"/>
	        <dialog name="vacto" num="3"/>
	    </trigger>
	</quest>
	<quest name="vactoToTheFarm" locked="false">
	    <trigger>
	        <location name="eleom3"/>
	        <dialog name="vacto" num="5"/>
	    </trigger>
	    <action>
	        <sound name="ZildoAccomplishQuest"/>
	    </action>
	</quest>
	
	<quest name="findRewardBarrel" locked="false">
	    <trigger>
	        <location name="eleom3"/>
	        <dialog name="pano" num="0"/>
	    </trigger>
	    <action>
	        <take value="70"/>
	        <remove who="pano"/>
	    </action>
	</quest>
	
	<quest name="christaAccept">
	    <trigger>
	        <location name="fermem2"/>
	        <dialog name="christa" num="3"/>
	    </trigger>
	    <action>
	        <sound name="ZildoAccomplishQuest"/>
	        <focus who="christa"/>
	        <moveTo who="christa" pos="174,199" speed="1"/>
	        <moveTo who="christa" pos="208,295"/>
	        <perso who="christa" alphaA="-2"/>
	       	<wait value="80"/>
	       	<focus who="zildo" delta="true"/>
	       	<remove who="christa"/>
	    </action>
	</quest>
	
	<quest name="vactoRequest" locked="false">
	    <trigger>
	        <location name="ferme"/>
	        <dialog name="vacto" num="1"/>
	    </trigger>
	</quest>
	
	<quest name="grandMotherTold" locked="false">
	    <trigger>
	        <location name="chateausud"/>
	        <dialog name="irma" num="6"/>
	    </trigger>
	</quest>
	
	<quest name="cavef2Hot">
	    <trigger>
	        <location name="cavef2"/>
	    </trigger>
	    <action>
	        <wait value="40"/>
	        <speak who="zildo" text="cavef2.hot"/>
	    </action>
	</quest>
	
	<quest name="cavef6_lev1" locked="false">
		<trigger>
			<location name="cavef6"/>
			<tileattack tilePos="11,6"/>
		</trigger>
		<action>
		    <exec script="activeLever(11,6)"/>
		    <wait value="20"/>
		    <!-- Move plateform -->
	    	<moveTo what="platef1" pos="0,140" delta="true" way="easein"/>
		    <wait value="5"/>
		    <moveTo what="platef1" pos="290,0" delta="true" way="easein"/>
		    <wait value="50"/>
		    <moveTo what="platef1" pos="-290,0" delta="true" way="easein"/>
		    <wait value="5"/>
   		    <moveTo what="platef1" pos="0,-140" delta="true" way="easein"/>
   		    <exec script="resetLever(11,6)"/>
		    <markQuest name="cavef6_lev1" value="false"/>
   		</action>
	</quest>
	
	<quest name="cavef6_button1" locked="false">
	    <trigger>
	   	    <location name="cavef6" tilePos="13,19" gear="TIMED_BUTTON"/>
	   	    <questDone name="!cavef6_plat2"/>
	    </trigger>
	    <action>
	        <moveTo what="platef2" pos="-270,0" delta="true" way="easein"/>
   	    </action>
   	</quest>

	<quest name="cavef6_button2" locked="false">
	    <trigger>
	   	    <location name="cavef6" tilePos="13,21" gear="TIMED_BUTTON"/>
	    </trigger>
	    <action>
	        <moveTo what="platef3" pos="0,-32" delta="true" way="easein"/>
	        <wait value="50"/>
	        <moveTo what="platef3" pos="0,32" delta="true" way="easein"/>
	        <markQuest name="cavef6_button2" value="false"/>
	    </action>
   	</quest>
   	
	<quest name="cavef6_lever2" locked="false">
	    <trigger>
	        <location name="cavef6"/>
	        <tileattack tilePos="3,36"/>
	    </trigger>
	    <action>
	        <exec script="activeLever(3,36)"/>
	        <moveTo what="platef5" pos="-224,0" delta="true" way="easein"/>
	        <wait value="50"/>
	        <moveTo what="platef5" pos="224,0" delta="true" way="easein"/>
	        <exec script="resetLever(3,36)"/>
	        <markQuest name="cavef6_lever2" value="false"/>
	    </action>
	</quest>

	<quest name="cavef6_lever3" locked="false">
	    <trigger>
	        <location name="cavef6"/>
	        <tileattack tilePos="29,28"/>
	    </trigger>
	    <action>
	        <exec script="activeLever(29,28)"/>
	        <wait value="250"/>
	        <moveTo what="platef4" pos="0,-128" delta="true" way="easein"/>
	        <wait value="50"/>
	        <moveTo what="platef4" pos="0,128" delta="true" way="easein"/>
	        <exec script="resetLever(29,28)"/>
	        <markQuest name="cavef6_lever3" value="false"/>
	    </action>
	</quest>
	
	<!-- When plateform is on the left -->
	<quest name="cavef6_plat2" locked="false">
	    <trigger>
	        <location name="cavef6" mover="platef2"/>
	        <questDone name="cavef6_button1"/>
	    </trigger>
	    <action>
	        <wait value="10"/>
	        <moveTo what="platef2" pos="270,0" delta="true" way="easein"/>
	        <markQuest name="cavef6_plat2"/>
	        <markQuest name="cavef6_button1"/>
	    </action>
    </quest>
    
	<quest name="cavef7_lever">
	    <trigger>
	        <location name="cavef7"/>
	        <tileattack tilePos="15,39"/>
	    </trigger>
	    <action>
	        <exec script="activeLever(15,39)"/>
	        <activate what="door1" value="true"/>
	        <activate what="door2" value="true"/>
	    </action>
	</quest>
	
	<quest name="cavef6_platef6_forward" locked="false">
        <trigger>
            <location name="cavef6" mover="platef6"/>
            <questDone name="!cavef6_platef6_up"/>
        </trigger>
        <action>
            <moveTo what="platef6" pos="-56,-56" delta="true" way="easein"/>
            <wait value="50"/>
            <markQuest name="cavef6_platef6_up" value="true"/>
            <markQuest name="cavef6_platef6_back" value="false"/>
        </action>
    </quest>

	<!-- Plateform going as soon as hero left it -->
    <quest name="cavef6_platef6_back" locked="false">
        <trigger>
            <location name="cavef6" mover="!platef6"/>
            <questDone name="cavef6_platef6_up"/>
        </trigger>
        <action>
            <moveTo what="platef6" pos="56,56" delta="true"/>
            <wait value="50"/>
          <markQuest name="cavef6_platef6_up" value="false"/>
            <markQuest name="cavef6_platef6_forward" value="false"/>
        </action>
    </quest>

    <quest name="cavef6_platef6_up" locked="false"/>
	
    <quest name="dragonShouldMove1" locked="false">
        <trigger>
            <location name="dragon" pos="149,504" radius="9"/>
        </trigger>
        <action>
            <markQuest name="dragonShouldMove2" value="false"/>
            <markQuest name="dragonShouldMove3" value="false"/>
            <markQuest name="dragonShouldMove4" value="false"/>
            <markQuest name="dragonShouldMove5" value="false"/>
        </action>
    </quest>
    <quest name="dragonShouldMove2" locked="false">
        <trigger>
            <location name="dragon" pos="423,279" radius="7"/>	<!--  9 -->
        </trigger>
        <action>
            <markQuest name="dragonShouldMove1" value="false"/>
            <markQuest name="dragonShouldMove3" value="false"/>
            <markQuest name="dragonShouldMove4" value="false"/>
            <markQuest name="dragonShouldMove5" value="false"/>
        </action>
    </quest>
    <quest name="dragonShouldMove3" locked="false">
        <trigger>
            <location name="dragon" pos="792,295" radius="9"/>
        </trigger>
        <action>
            <markQuest name="dragonShouldMove1" value="false"/>
            <markQuest name="dragonShouldMove2" value="false"/>
            <markQuest name="dragonShouldMove4" value="false"/>
            <markQuest name="dragonShouldMove5" value="false"/>
       	</action>
    </quest>
    <quest name="dragonShouldMove4" locked="false">
        <trigger>
            <location name="dragon" pos="167,183" radius="9"/>
        </trigger>
        <action>
            <markQuest name="dragonShouldMove1" value="false"/>
            <markQuest name="dragonShouldMove2" value="false"/>
            <markQuest name="dragonShouldMove3" value="false"/>
            <markQuest name="dragonShouldMove5" value="false"/>
       	</action>
    </quest>
    <quest name="dragonShouldMove5" locked="false">
        <trigger>
            <location name="dragon" pos="742,663" radius="11"/>
        </trigger>
        <action>
            <markQuest name="dragonShouldMove1" value="false"/>
            <markQuest name="dragonShouldMove2" value="false"/>
            <markQuest name="dragonShouldMove3" value="false"/>
            <markQuest name="dragonShouldMove4" value="false"/>
       	</action>
    </quest>
    
    <quest name="meetDragon">
        <trigger>
            <location name="cavef8" pos="159,226" radius="1"/>
        </trigger>
        <action>
            <exec script="heroMeetDragon"/>
        </action>
    </quest>

    <quest name="killDragon" locked="false">
	    <trigger>
	        <location name="dragon"/>
	        <dead who="dragon"/>
	    </trigger>
	    <action>
	        <var name="bossFighting" value="0" />
	        <perso who="dragon" action=""/>
	        <music/>
   	        <perso who="dragon" action="explodeBigBoss(0,-90)"/>
   	        <perso who="dragon" action="dropKey"/>
   	        <wait value="60"/>
  	        <remove who="dragon"/>
	    </action>
	</quest>
	
    <!-- 3 rocks in dragon cave : respawn only if given one hasn't wounded dragon -->
    <quest name="fallRockA" locked="false" repeat="true">
	    <trigger>
	        <location name="dragon"/>
		    <fall type="STONE_HEAVY" name="rockA"/>
  		    <wound who="!dragon"/>
	    </trigger>
	    <action>
            <markQuest name="needToRespawnRockA" value="true"/>
	    </action>
	</quest>
	
	<quest name="needToRespawnRockA" locked="false"/>
	<quest name="reappearRockA" repeat="true" locked="false">
	    <trigger>
	        <questDone name="needToRespawnRockA"/>
	        <location name="dragon" pos="149,438" radius="-10"/>	<!-- if hero is away from 20 tiles -->
   	    </trigger>
	    <action>
	   		<spawn type="STONE_HEAVY" what="rockA" pos="149,438" floor="2" z="0"/>
	   		<markQuest name="needToRespawnRockA" value="false"/>
	    </action>
   	</quest>
   	
	<!-- Rock 2/3 B -->
	 <quest name="fallRockB" locked="false" repeat="true">
	    <trigger>
	        <location name="dragon"/>
		    <fall type="STONE_HEAVY" name="rockB" nature="BOTTOMLESS"/>
		    <wound who="!dragon"/>
	    </trigger>
	    <action>
            <markQuest name="needToRespawnRockB" value="true"/>
	    </action>
	</quest>
	
	<quest name="needToRespawnRockB" locked="false"/>
	<quest name="reappearRockB" repeat="true" locked="false">
	    <trigger>
	        <questDone name="needToRespawnRockB"/>
	        <location name="dragon" pos="840,271" radius="-10"/>	<!-- if hero is away from 20 tiles -->
	    </trigger>
	    <action>
	   		<spawn type="STONE_HEAVY" what="rockB" pos="840,271" floor="2" z="0"/>
	   		<markQuest name="needToRespawnRockB" value="false"/>
	    </action>
   	</quest>
   	
	<!-- Rock 3/3 C -->
    <quest name="fallRockC" locked="false" repeat="true">
	    <trigger>
	        <location name="dragon"/>
		    <fall type="STONE_HEAVY" name="rockC" nature="BOTTOMLESS"/>
		    <wound who="!dragon"/>
   	    </trigger>
	    <action>
            <markQuest name="needToRespawnRockC" value="true"/>
	    </action>
	</quest>
	
	<quest name="needToRespawnRockC" locked="false"/>
	<quest name="reappearRockC" repeat="true" locked="false">
	    <trigger>
	        <questDone name="needToRespawnRockC"/>
	        <location name="dragon" pos="637,542" radius="-10"/>	<!-- if hero is away from 20 tiles -->
	    </trigger>
	    <action>
	   		<spawn type="STONE_HEAVY" what="rockC" pos="637,539" floor="2" z="0"/>
	   		<markQuest name="needToRespawnRockC" value="false"/>
	    </action>
   	</quest>
   	
	<quest name="stopFireBalls" locked="false">
	    <trigger>
		    <location name="cavef10" pos="161,119" radius="1"/>
	    </trigger>
	    <action>
	        <remove what="fireb1"/>
	        <remove what="fireb2"/>
   	        <remove what="fireb3"/>
   	        <remove what="fireb4"/>
   	    </action>
	</quest>
	
	<quest name="findDragonPortalKey">
	    <trigger>
	        <location name="dragon"/>
	        <inventory item="PORTAL_KEY"/>
	    </trigger>
	    <action>
	        <exec script="ep3_closure"/>
	    </action>
	</quest>
	
    <!-- Show up some clouds on dragon's map -->
    <tileAction id="makeCloudsDragon">
	    <for var="loc:j" value="30">
		   	<animation type="CLOUD_FOG" pos="451 + random*80, 100 + random*48"/>
		   	<if exp="dice10>5">
		   	    <wait value="2"/>
		   	</if>
	    </for>
    </tileAction>

    <!-- Make rocks fall from the sky on dragon's map -->
    <tileAction id="fallRocks">
        <for var="loc:i" value="18">
		    <spawn type="STONE_HEAVY" pos="451 + random*80, 100 + random*48" z="80" az="-0.1"/>
		    <wait value="8"/>
		    <if exp="dice10>4">
		        <wait value="5"/>
		    </if>
        </for>
	</tileAction>
    
    <tileAction id="regenSpider">
    	<!-- For now, a bug imposes to add an useless action, just to avoid 'uniqueAction' detected in timer execution -->
        <var name="a" value="r"/>
        <timer each="500">
            <action>
		    	<lookFor info="ENEMY" pos="x*16,y*16" radius="6" negative="true">
					<spawn who="loc:spider" type="STONE_SPIDER" info="ENEMY" pos="x*16+8,y*16+8" carried="dice10>6:BOMBS3,NULL"/>
				</lookFor>
	    	</action>
    	</timer>
   	</tileAction>
    	
    <tileAction id="lavaBubbles">
    	<for var="loc:i" value="40">
			<animation type="LAVA_DROP" pos="x*16 + random*80, y*16 + random*48"/>
			<if exp="dice10>4">
			    <wait value="1"/>
			</if>
		</for>
    </tileAction>
    	
   	<mapScript>
	    <condition name="sousbois2" locked="false">
	        <tile pos="21,6" action="blueRain" unblock="true"/>
	    </condition>
		<condition name="sousbois3">
			<perso who="sacher" action="sacherTortue('tortueSousbois3')"/>
		</condition>
		<condition name="sousbois5">
			<perso who="tortue1" action="sacherTortue('tortueSousbois5_1')"/>
			<perso who="tortue2" action="sacherTortue('tortueSousbois5_2',1)"/>
		</condition>
		<condition name="sousbois7">
			<perso who="sacher" action="sacherTortue('tortueSousbois7')"/>
	   		<perso who="sacher2" action="sacherTortue('tortueSousbois7_2')"/>
		</condition>
		<condition name="sousbois4">
			<if expQuest="hero_princess">
		        <!-- Only for Roxy, display fireflies -->
				<tile pos="26,11" action="fireflies"/>
				<tile pos="52,7" action="fireflies"/>
				<tile pos="34,26" action="fireflies"/>
				<tile pos="42,26" action="fireflies"/>
				<tile pos="41,4" action="fireflies"/>
				<!-- Hide notes, so player will only see fireflies -->
				<visible who="arsinoe" value="false"/>
	   			<visible who="archibald" value="false"/>
	   			<visible who="crystallion" value="false"/>
	   			<visible who="porphyre" value="false"/>
	   			<visible who="neptune" value="false"/>
			</if>
			<if expQuest="!hero_princess">
			    <remove who="arsinoe"/>
			    <remove who="archibald"/>
			    <remove who="crystallion"/>
			    <remove who="porphyre"/>
			    <remove who="neptune"/>
   			</if>
		</condition>
	   	<condition name="sousbois6">
	   		<tile pos="51,11" action="willOWist" unblock="true"/>
	   		<markQuest name="goOnStump" value="false"/>
	   	</condition>
	   	<condition name="prison">
	   	    <perso who="noir" pv="6"/>"
	   	    <markQuest name="isKillGard1" value="false"/>
	   	</condition>
	   	<condition name="prison8">
	   	    <perso who="noirg" pv="4"/>
	   	</condition>
	   	<condition name="prison9">
	   	    <markQuest name="isKillGard1" value="false"/>
	   	</condition>
	   	<condition name="prison9" exp="prison10Button">
	   	    <activate what="grey" value="true" unblock="true"/>
	   	</condition>
	   	<condition name="prison12">
	   	    <perso who="noir1" pv="6"/>
	   	    <perso who="noir2" pv="6"/>
   	   	</condition>
   	   	<condition name="prison9">
	   	    <markQuest name="prison12Locked" value="false" />
	   	</condition>
	   	<condition name="prison12" exp="fromPrison13">
	   	    <activate what="locked" value="true" unblock="true"/>
	   	</condition>
	   	<condition name="prison13">
	   	    <markQuest name="fromPrison13" value="true"/>
	   	</condition>
	   	<condition name="prison14">
	   	    <activate what="doorUp" value="true" unblock="true"/>
	   	    <if expQuest="killBossTurret1">
			   	<remove what="doorDown"/>
	   	    </if>
	   	</condition>
	   	<condition name="prison15">
	   	    <markQuest name="prison15_trigger1Launch1" value="false"/>
	   	    <markQuest name="prison15_trigger2Launch1" value="false"/>
	   	    <markQuest name="prison15_trigger1Launch2" value="false"/>
	   	    <markQuest name="prison15_trigger2Launch2" value="false"/>
	   	    <markQuest name="prison15_trigger1Launch3" value="false"/>
	   	    <markQuest name="prison15_trigger2Launch3" value="false"/>
	   	    <markQuest name="prison15_trigger1Launch4" value="false"/>
	   	    <markQuest name="prison15_trigger2Launch4" value="false"/>
   	   	</condition>
   	   	<condition name="prison16" exp="killKingGuards">
   	   	   	<remove who="noir1"/>
   	   	   	<remove who="noir2"/>
   	   	</condition>
   	   	<condition name="d4m9" exp="!jump_stumpNature3">
   	   		<remove who="igor"/>
   	   	</condition>
   	   	<condition name="prison16">
   	   		<perso who="noir1" pv="6"/>"
   	   		<perso who="noir2" pv="6"/>"
   	   	</condition>
   	   	<condition name="prison17" exp="metKingPrison3">
   	   	    <remove who="king"/>
   	   	</condition>
   	   	<condition name="eleom1">
   	   	    <spawn impact="CAULDRON" pos="88,42"/>
   	   	    <tile pos="5,2" action="bubbleCauldron" unblock="true"/>
   	   	    <script who="eleoric" value="0" effect="2"/> <!-- small zone, with 2 radius -->
   	   	    <if expQuest="!eleoWaitForVacto">
   	   	        <markQuest name="eleoSpeak" value="false"/>
   	   	    </if>
   	   	    <!-- Ambient sound -->
   	   	    <sound name="Boiling" pos="85,39"/>
   	   	</condition>
   	   	<condition name="chateausud">
			<tile pos="32,10" action="illTree"/> <tile pos="42,10" action="illTree"/>
			<tile pos="7,10" action="fountain"/>
			<tile pos="20,10" action="fountain"/>
			<tile pos="7,16" action="fountain"/>
			<tile pos="20,16" action="fountain"/>
			<sound name="Fountain" pos="217,215"/>
		</condition>
   	   	<condition name="chateausud" exp="!christaAccept">
   	   		<remove who="christa"/>
   	   		<remove who="vacto"/>
   	   	</condition>
		<condition name="eleom2">
		    <perso who="carlo" z="12"/>
		</condition>
		<condition name="eleog" exp="secretEleog">
		    <activate what="door" value="true" unblock="true"/>
		</condition>
		<condition name="ferme" exp="!eleog(13, 3)">
		    <remove what="crack"/>
		</condition>
		<condition name="ferme" exp="!vactoToTheFarm,christaAccept">
		    <remove who="vacto"/>
		</condition>
		<condition name="ferme" exp="vactoToTheFarm">
		    <remove who="christa"/>
		</condition>
		<condition name="fermem2" exp="!vactoToTheFarm,christaAccept">
		    <remove who="christa"/>
		</condition>
		<condition name="cavef9">
		    <perso who="elemental" action="elemBehav"/>
		</condition>
		<condition name="cavef6">
		    <perso who="fire1" action="elemBehav"/>
		    <perso who="fire2" action="elemBehav"/>
	        <markQuest name="cavef6_lev1" value="false"/>
	        <markQuest name="cavef6_button2" value="false"/>
	        <markQuest name="cavef6_lever2" value="false"/>
	        <markQuest name="cavef6_lever3" value="false"/>
	        <markQuest name="cavef6_platef6_forward" value="false"/>
			<markQuest name="cavef6_platef6_back" value="false"/>
			<markQuest name="cavef6_platef6_up" value="false"/>
	    </condition>
		<condition name="cavef7" exp="cavef7_lever">
		    <tile pos="15,25" back2="135+256*10"/>
		    <activate what="door1" value="true" unblock="true"/>
	        <activate what="door2" value="true" unblock="true"/>
			<markQuest name="cavef6_platef6_forward" value="false"/>
		</condition>
		<condition name="cavef6" exp="cavef6_button1">
		    <!-- Replace immediately the plateform (note that 'pos' action doesn't work here) -->
		    <moveTo what="platef2" pos="-270,0" delta="true" speed="270" unblock="true"/>
		</condition>
		<condition name="cavef10">
		    <animation type="BIG_FIREBALL" what="fireb1" angle="3" pos="304,387"/>
		    <animation type="BIG_FIREBALL" what="fireb2" angle="3" pos="304,291"/>
		    <animation type="BIG_FIREBALL" what="fireb3" angle="1" pos="16,339"/>
		    <animation type="BIG_FIREBALL" what="fireb4" angle="1" pos="16,244"/>
		</condition>
		<condition name="cavef8">
		    <remove chaining="dragon"/>
		</condition>
		<condition name="dragon">
		    <tile pos="9,3" action="regenSpider"/>
<!--		
		    <perso who="dragon" action="bossDragon"/>
-->	
		</condition>
		<condition name="sousbois3" exp="removeNailForMoonStone">
			<tile pos="11,28" back2="-1"/>
			<tile pos="12,28" back2="-1"/>
		</condition>
		<condition name="eleom3" exp="vactoToTheFarm">
		    <remove who="vacto"/>
		</condition>
		<condition name="eleom3" exp="!grandMotherTold,findRewardBarrel">
		    <remove who="pano"/>
		</condition>
		<condition name="lugduniag" exp="getBackIgor">
		    <remove who="hector"/>
		</condition>
	</mapScript>
		
	<scene id="intro_episode3">
		<speak what="camera" text="ep3.beginning.0"/>	
		<speak what="camera" text="ep3.beginning.1"/>
		<music name="Squirrel"/>	
		<speak what="camera" text="ep3.beginning.2"/>
		<markQuest name="hero_princess" value="true"/>
		<map name="sousbois1"/>
		<pos what="camera" pos="240,81" />
		<fadeIn value="0"/>
		<wait value="50"/>
		<moveTo what="camera" pos="330,0" />
		<focus who="zildo"/>
		<pos who="zildo" pos="655,89"/>
		<moveTo who="zildo" pos="571,145" unstoppable="true"/>
		<speak who="synthe" text="info.episode3"/>
		<!-- Remove old sword -->
		<putDown item="sword" />
		<herospecial value="3"/>	<!-- Save game -->
	</scene>
	
	<scene id="meetIsidore">
		<!--  Remember that Roxy's character when she's a squirrel, is 'zildo' ( ... ) -->
		<music name="Isidore"/>
		<angle who="zildo" value="1"/>
		<focus who="isidore" delta="true"/>
		<wait value="60"/>
		<angle who="isidore" value="3"/>
		<speak text="sousbois.isidore.0" who="isidore"/>
		<moveTo who="isidore" pos="432,619"/>
		<moveTo who="zildo" pos="409,632"/>
		<nameReplace who="isidore" name="isidore"/>
		<speak text="sousbois.isidore.1" who="isidore"/>
		<speak text="sousbois.roxy.0" who="zildo"/>
		<speak text="sousbois.isidore.2" who="isidore"/>
		<wait value="20"/> <!--  Isidore turns around Roxy and wait 2 times -->
		<moveTo who="isidore" pos="401,614"/>
		<angle who="isidore" value="2"/>
		<wait value="30"/>
		<moveTo who="isidore" pos="426,620"/>
		<moveTo who="isidore" pos="426,640"/>
		<angle who="isidore" value="3"/>
		<wait value="50"/>
		<moveTo who="isidore" pos="432,619"/> <!-- he stops his dance -->
		<angle who="isidore" value="3"/>
		<speak text="sousbois.isidore.3" who="isidore"/>
		<speak text="sousbois.roxy.1" who="zildo"/>
		<speak text="sousbois.isidore.4" who="isidore"/>
		<speak text="sousbois.roxy.2" who="zildo"/>
		<speak text="sousbois.isidore.5" who="isidore"/>
		<speak text="sousbois.roxy.3" who="zildo"/>
		
		<speak text="sousbois.isidore.6" who="isidore"/>
		<wait value="50"/>
		<angle who="zildo" value="2"/>
		<wait value="50"/>
		<moveTo who="isidore" pos="-1,0" delta="true"/>
		<sound name="MoonFusion"/>
		<speak text="sousbois.isidore.7" who="isidore"/>
		<angle who="zildo" value="1"/>
		<speak text="sousbois.roxy.4" who="zildo"/>
		<speak text="sousbois.isidore.8" who="isidore"/>
		<speak text="sousbois.roxy.5" who="zildo"/>
		<speak text="sousbois.isidore.9" who="isidore"/>
		<speak text="sousbois.isidore.10" who="isidore"/>
		<speak text="sousbois.roxy.6" who="zildo"/>
		<speak text="sousbois.isidore.11" who="isidore"/>
		<speak text="sousbois.roxy.7" who="zildo"/>
		<speak text="sousbois.isidore.12" who="isidore"/>
		<focus who="zildo" delta="true"/>
		<moveTo who="zildo" pos="491,643" unblocked="true"/>
		<moveTo who="isidore" pos="452,580"/>
		<wait value="20"/>
		<music/>
		<angle who="zildo" value="2"/>
		<speak text="sousbois.roxy.8" who="zildo"/>				
		<music name="Squirrel"/>
	</scene>
	
	<tileAction id="fireflies">
		<spawn what="loc:firefly" type="PURPLE_FIREFLY"
				   pos="x*16, y*16" z="4" alpha="180"
				   foreground="true" />
	   	<timer each="80+random*15">
			<action>
				<!-- 'unblock' is REALLY important here ! Because without it, number of scripts keeps on increasing, because 
					 'moveTo' is never declared 'achieved' because the following one at the next timer triggering will set a 
					 new destination, meaning previous one will never be reached. 
					 Today, I see 2 options : 
					 1) add 'unblock' on such moveTo in timers, like here (manually or automatically)
					 2) ignore timer trigger if previous actions weren't all achieved 
			   	-->
				<moveTo what="loc:firefly" pos="x*16+random*40,y*16+random*30" way="arc" zoom="128+bell*128" unblock="true"/>
			</action>
		</timer>
	</tileAction>
	
	<tileAction id="willOWist">
		<!-- Le feu follet pourra émettre un petit scintillement lorsque l'écureuil le suivra comme il faut des yeux, ça aidera le joueur à savoir s'il
			est sur la bonne voie -->
		<spawn what="wow" type="WILL_O_WIST" pos="x*16+8,y*16-10" z="10" chained="3, 4" />
		<spawn what="wowReflect" type="WILL_O_REFLECT" pos="x*16+8,y*16-20+16" zoom="128" alpha="64"/>
		<loop>
			<actions>
				<moveTo what="wow" pos="50,40" delta="true" way="circular" zoom="128+bell*32"/>
				<moveTo what="wowReflect" pos="50,40" delta="true" way="circular" zoom="128+bell*64"/>
			</actions>
   		</loop>
	</tileAction>
	
	<tileAction id="blueRain">
		<timer each="10+random*30">
			<action>
				 <spawn what="loc:drop" type="DROP_SMALL" pos="x*16+random*16,y*16+random*8" z="60"
					 az="-0.01" vx="-0.1-random*0.1" alpha="200" alphaA="0.1" vy="0.1"/>
				 <wait value="50"/>
				 <sprite what="loc:drop" type="DROP_MEDIUM"/>
			</action>
		 </timer>
	</tileAction>
	
	<!-- Turtle script: awaken when someone walks near her, then falls asleep. -->
	<!-- arguments: arg0=scene name for turtle movements,
	                arg1=1 if turtle is awaken by sound around her / 0 otherwise-->
	<persoAction id="sacherTortue"> 
		<script who="self" value="17"/> <!-- MOBILE_WAIT: sure to reach its target -->
		<angle who="self" value="1"/>
		<loop>
			<var name="loc:found" value="0"/>
			<lookFor who="self" radius="3">
				<var name="loc:found" value="1"/>
			</lookFor>
			<if exp="loc:arg1=1">
				<listen who="self">
					<var name="loc:found" value="1"/>
				</listen>
			</if>
			<if exp="loc:found=1">
				<!-- Turtles arise if hero's is around -->
				<exec script="turtleAwake"/>
				<var name="loc:nobody" value="0"/>
				<loop when="loc:nobody=0">
					<!-- Expect argument is gived to this persoAction -->
					<exec script="loc:arg0"/>
					<lookFor who="self" info="ZILDO" radius="3" negative="true">
						<var name="loc:nobody" value="1"/>
					</lookFor>
				</loop>
				<!-- If hero's gone, back to sleep -->
				<exec script="turtleSleep"/>
			</if>
			<wait value="40"/>
		</loop>
   	</persoAction>
   	
	<!-- Dragon drop his key when he dies -->
	<persoAction id="dropKey">
	    <wait value="100"/>
	    <sound name="ZildoTombe"/>
	    <spawn type="PORTAL_KEY" pos="x,y-40" z="40" vy="0.5" vz="1.5" az="-0.04"/>
	</persoAction>
	
	<scene id="turtleAwake">
	    <seq who="self" addSpr="1,2,3" wait="6"/>
		<wait value="14"/>
		<spawn who="loc:head" type="TURTLE" angle="1" pos="x+11,y-5" addSpr="8"/>
	    <seq who="loc:head" addSpr="8,9,10" wait="2"/>
		<actions>
			<perso who="self" addSpr="4"/>
			<pos who="self" pos="x+3,y"/>
			<remove who="loc:head"/>
		</actions>
		<wait value="20"/>
	</scene>
	
	<scene id="turtleSleep">
		<angle who="self" value="1"/>
		<actions>
			<perso who="self" addSpr="3"/>
			<pos who="self" pos="x-3,y"/>
			<spawn who="loc:head" type="TURTLE" angle="1" pos="x+11,y-5" addSpr="10"/>
		</actions>
		<seq who="loc:head" addSpr="10,9,8" wait="2"/>
		<remove who="loc:head"/>
		<seq who="self" addSpr="2,1,0" wait="6"/>
		<wait value="14"/>
	</scene>
	
	<scene id="tortueSousbois3">
		<moveTo who="sacher" pos="0,39" delta="true"/>
		<wait value="100"/>
		<moveTo who="sacher" pos="1,0" delta="true"/>
		<wait value="4"/>
		<moveTo who="sacher" pos="0,-40" delta="true"/>
		<wait value="100"/>
		<moveTo who="sacher" pos="-41,0" delta="true"/>
		<wait value="100"/>
		<moveTo who="sacher" pos="0,1" delta="true"/>
		<wait value="4"/>
		<moveTo who="sacher" pos="40,0" delta="true"/>
		<wait value="100"/>
	</scene>
	
	<scene id="tortueSousbois5_1">
	    <moveTo who="tortue1" pos="-130,0" delta="true"/>
	    <wait value="100"/>
	    <moveTo who="tortue1" pos="130,0" delta="true"/>"/>
	    <wait value="100"/>
	</scene>
	
	<scene id="tortueSousbois5_2">
	    <moveTo who="tortue2" pos="0,68" delta="true"/>
	    <wait value="5"/>
	    <moveTo who="tortue2" pos="-150,0" delta="true"/>
	    <wait value="5"/>
	    <moveTo who="tortue2" pos="150,0" delta="true"/>
	    <wait value="5"/>
  	    <moveTo who="tortue2" pos="0,-68" delta="true"/>"/>
	    <wait value="100"/>
	</scene>
	
	<scene id="tortueSousbois7">
		<moveTo who="sacher" pos="0,-30" delta="true"/>
		<wait value="50"/>
		<moveTo who="sacher" pos="200,0" delta="true"/>
		<wait value="50"/>
		<moveTo who="sacher" pos="-200,0" delta="true"/>
		<wait value="50"/>
		<moveTo who="sacher" pos="0,30" delta="true"/>
		<wait value="50"/>
	</scene>
	
	<scene id="tortueSousbois7_2">
		<moveTo who="sacher2" pos="0,210" delta="true"/>
		<wait value="50"/>"
		<moveTo who="sacher2" pos="150,0" delta="true"/>
		<wait value="50"/>
		<moveTo who="sacher2" pos="-150,0" delta="true"/>
		<wait value="50"/>"
		<moveTo who="sacher2" pos="0,-210" delta="true"/>
		<wait value="50"/>
	</scene>
	
	<!-- IDEE: créer une action 'varInc' qui incrémente une variable, en utilisant le syntaxic sugar -->
	<scene id="checkWillOWist">
		<var name="loc:duration" value="0"/>
		<var name="loc:looking" value="0"/>	<!-- define outside of the 'loop' context: important -->
		<loop when="zildo.z!=0">
			<var name="loc:looking" value="0"/>
			<lookFor who="zildo" radius="6" sight="true" type="WILL_O_WIST">
				<!-- hero is watching will'o'wist -->
				<var name="loc:looking" value="1"/>
				<var name="loc:duration" value="loc:duration+1"/>
				<if exp="loc:duration=7 | loc:duration=14">
					<!-- Sprite context is propagated to the scene -->
					<exec script="starSparkle"/>
					<if exp="loc:duration=14">
						<markQuest name="jump_stumpNatureReady" value="true"/>
					</if>
				</if> 
				<wait value="60"/>
			</lookFor>
			<if exp="loc:looking=0">
				<var name="loc:duration" value="0"/>
				<wait value="5"/>
			</if>
		</loop>
		<markQuest name="jump_stumpNature1" value="false"/>
		<markQuest name="jump_stumpNature2" value="false"/>
	</scene>
	
	<!-- Spawn some stars vanishing quickly -->
	<scene id="starSparkle">
		<sound name="Sort"/>
		<for var="loc:i" value="3">
			<spawn impact="STAR_YELLOW" pos="x,y" vy="-0.8" vx="-0.5+random" alphaA="-1"/>
			<wait value="3"/>
		</for>
	</scene>
	
	<scene id="openNatureRoxy">
		<music name=""/>
		<actions>
			<animation pos="834,188" type="CLOUD_FOG" />
			<animation type="BUSHES" pos="834, 188"/>
		   	<perso who="zildo" az="-0.1" vz="3.4"/>
			<script who="zildo" text="TOMBE" />
		</actions>
		<actions>
			<remove what="leaves"/>
			<spawn what="holeStump" type="HOLE_STUMP" pos="832, 192"/>
		</actions>
		<actions>
	   		<moveTo who="zildo" pos="831, 195"/>
			<sound name="Gas"/>
			<for var="loc:i" value="16">
   				<spawn what="loc:leaf" pos="830+random*10,185+random*8" type="LEAF_GREEN" reverse="dice10>4:128,0" 
					vz="3.2+random*2" vx="random*2-1" az="-0.1" alphaA="-0.05"/>
			</for>
		</actions>
		<sound name="Gas"/>
		<perso who="zildo" az="-0.1" vz="1.4"/>
		<angle who="zildo" value="0"/>
		<wait value="4"/>
		<angle who="zildo" value="1"/>
		<wait value="3"/>
		<sound name="Gas"/>
		<angle who="zildo" value="2"/>
		<wait value="4"/>
		<angle who="zildo" value="3"/>
		<wait value="4"/>
		<angle who="zildo" value="0"/>
		<wait value="3"/>
		<angle who="zildo" value="1"/>   
				 
		<sound name="Gas"/>
		<perso who="zildo" vz="2.1"/>
		<wait value="9"/>
		<perso who="zildo" vz="2.1"/>
		<wait value="9"/>
		<perso who="zildo" vz="2.1"/>
		<angle who="zildo" value="2"/>
		
		<wait value="67"/>
		<visible who="zildo" value="false"/>
		<perso who="zildo" vz="0.1" az="0.1"/>
		<zoom who="zildo" value="0"/>
		<animation who="zildo" pos="1,-1" type="STAR_SHINE" />
		<sound name="ZildoFall"/>
		<wait value="50"/>
		<sound name="ZildoSecret"/>
		<wait value="130"/>
		<fadeOut type="5"/>
		<wait value="20"/>
		
		<!-- Fall in Palace of Nature -->
		<map name="nature1"/>
		<music name="Nature"/>
		<for var="loc:l" value="16">
			<spawn what="loc:leaf1" type="dice10>4:LEAF_GREEN,LEAF" pos="164+20*random,113+random*8" z="80-random*10"
			    reverse="dice10>4:128,0"
			    alphaA="-0.005" 
			    vz="-0.1-random*0.5" vx="-0.2+random*0.4" fx="-0.001" az="0"/>
		</for>
		<perso who="zildo" az="0" vz="0"/>
		<zoom who="zildo" value="255"/>
		<pos who="zildo" pos="174,113"/>
		<spawn type="LEAF_GREEN" pos="140,113" az="-0.001" z="30"/>
		<exec script="endFallPit"/>
		
		<wait value="20"/>
		<angle who="zildo" value="1"/>
		<wait value="10"/>
		<angle who="zildo" value="3"/>
		<speak who="zildo" text="endRoxyQuest.0"/>
		<wait value="15"/>
		<moveTo who="zildo" pos="-24,0" delta="true"/>
		<wait value="20"/>
		<speak who="zildo" text="endRoxyQuest.1"/>
		<moveTo who="zildo" pos="157,92"/>
		<angle who="zildo" value="0"/>
		<wait value="30"/>
		<moveTo who="zildo" pos="0,32" delta="true"/>
		<wait value="10"/>
		<angle who="zildo" value="3"/>
		<wait value="20"/>
		<angle who="zildo" value="1"/>
		<wait value="30"/>
		<moveTo who="zildo" pos="316,119" unblock="true"/>
		<wait value="60"/>
		<fadeOut value="0"/>
		<herospecial value="7"/>
		<speak what="camera" text="endRoxyQuest.2"/>
		<speak what="camera" text="endRoxyQuest.3"/>
		<wait value="50"/>
		<speak what="camera" text="endRoxyQuest.4"/>
		
		<!-- Now music in undergrowth will be  -->
		<zikReplace what="UNDERGROWTH" name="Nuit"/> <!--  Keep Squirrel music for the squirrel, replaced by night for hero -->
		
		<markQuest name="hero_princess" value="false"/>
		
		<!-- hero at the library -->
		<music name=""/>
		<map name="d4m2"/>
		<pos who="maltus" pos="190,33"/>
		<angle who="maltus" value="0"/>
		<pos who="zildo" pos="140,47"/>
		<fadeIn value="0" unblock="true"/>
		<moveTo who="zildo" pos="140,134" speed="0.5"/>
		<wait value="20"/>
		<angle who="zildo" value="0"/>
		<speak who="zildo" text="episode3.zildo.0"/>
		<speak who="anselme" text="episode3.anselme.0"/>
		<angle who="maltus" value="2"/>
		<speak who="maltus" text="episode3.maltus.0"/>
		<angle who="hector" value="3"/>
		<speak who="hector" text="episode3.hector.0"/>
		<speak who="zildo" text="episode3.zildo.1"/>
		<sound name="MenuMove"/><wait value="20"/>
		<sound name="MenuMove"/><wait value="20"/>
		<sound name="MenuMove"/><wait value="40"/>
		<sound name="MenuMove"/><wait value="20"/>
		<sound name="MenuMove"/><wait value="10"/>
		<sound name="MenuMove"/><wait value="10"/>
		<speak who="maltus" text="episode3.maltus.1"/>
		<speak who="hector" text="episode3.hector.1"/>
		<sound name="OuvrePorte"/>
		<spawn who="petula" type="RITASKY" pos="225,169" alpha="0" alphaA="2"/>
		<angle who="zildo" value="1"/>
		<angle who="hector" value="2"/>
		<wait value="50"/>
		<speak who="petula" text="episode3.girl.0"/>
		<speak who="hector" text="episode3.hector.2"/>
		<angle who="petula" value="2"/>
		<wait value="30"/>
		<perso who="petula" alphaA="-2"/>
	    <wait value="30"/>
	    <remove who="petula"/>
	    <moveTo who="zildo" pos="32,0" delta="true"/>
	    <speak who="zildo" text="episode3.zildo.2"/>
		<speak who="hector" text="episode3.hector.3"/>
		<speak who="maltus" text="episode3.maltus.2"/>
		<angle who="zildo" value="0"/>
	    <speak who="zildo" text="episode3.zildo.3"/>
	    <moveTo who="zildo" pos="16,0" speed="1" delta="true" unblock="true"/>
	    <wait value="8"/>
	    <speak who="hector" text="episode3.hector.4"/>
	    <angle who="zildo" value="0"/>
	    <speak who="hector" text="episode3.hector.5"/>
	    <speak who="zildo" text="episode3.zildo.4"/>
	    <moveTo who="maltus" pos="190,56"/>
		<speak who="maltus" text="episode3.maltus.3"/>
		<angle who="zildo" value="0"/>
		<wait value="5"/>
		<speak who="maltus" text="episode3.maltus.4"/>
		<speak who="zildo" text="episode3.zildo.5"/>
   	    <music name="Village"/>
	</scene>
	
	<!-- Move a turret underground, then breaks the floor, and shot bullets on hero. After that, crouch back into the ground -->
	<persoAction id="bossTurret"> <!-- argument: (arg0,arg1)=>location to go, arg2=>reverseH, arg3=>reverseV -->
	     
		<moveTo who="self" pos="loc:arg0,loc:arg1" way="arc"/>
		
		<perso who="self" alphaA="0.1"/>
		<wait value="30"/>
		<animation type="BREAKING_ROCK" pos="x-12,y-4"/>
		<wait value="1"/>
		<animation type="BREAKING_ROCK" pos="x,y"/>
		<wait value="2"/>
		<animation type="BREAKING_ROCK" pos="x+10,y+6"/>
		<var name="loc:turretSpr" value="1"/>
		<if exp="loc:arg3=1">
		    <var name="loc:turretSpr" value="5"/>
		</if>
		<script who="self" value="3"/>
		<actions>
		    <visible who="self" value="false"/>
		    <spawn who="loc:turretOut" type="TURRET" addSpr="loc:turretSpr" pos="x,y"/>
			<!-- Turret is invulnerable (flag 4) -->
		    <perso who="loc:turretOut" addSpr="loc:turretSpr" flag="4" info="ENEMY" alpha="255"/>
			<var name="loc:posX" value="x+7"/>
			<!-- Cancel reverse vertical, but keep horizontal one -->
			<perso who="loc:turretOut" reverse="0"/>
			<if exp="loc:arg2=1">
			    <var name="loc:posX" value="x-7"/>
			    <perso who="loc:turretOut" reverse="128"/>
			</if>
		</actions>
		<wait value="50"/>
		<sound name="ZildoPousse"/>

		<!-- Turret appears -->
		<spawn who="loc:subSubHead" type="TURRET" addSpr="2" pos="loc:posX,y-1" z="17"/>
		<wait value="4"/>
		<perso who="loc:subSubHead" z="18"/>
		<wait value="4"/>
		<perso who="loc:subSubHead" z="19"/>
		<wait value="4"/>
		<spawn who="loc:subHead" type="TURRET" addSpr="3" pos="loc:posX,y-2" z="19"/>
		<wait value="4"/>
		<perso who="loc:subHead" z="20"/>
		<wait value="4"/>
		<perso who="loc:subHead" z="22"/>
		<wait value="8"/>
		<spawn who="loc:canon" type="TURRET" addSpr="4" pos="loc:posX,y-3" z="27"/>
		<wait value="2"/>
		<perso who="loc:canon" z="28"/>
		<wait value="2"/>
		<perso who="loc:canon" z="29"/>
		
		<var name="BOSS_turret_phase" value="1"/>
		
		<!-- Attack x2 -->
		<for var="loc:j" value="2">
		    <for var="loc:i" value="5">
		        <sound name="CannonBall"/>
			    <throw who="loc:turretOut" pos="loc:posX, y-6" to="zildo.x+random*4-2,zildo.y+random*4-2" speed="2.4"
		      		 	   type="BULLET" z="22" vz="-0.2" zoom="255"/>
			    <wait value="4"/>
			</for>
			<wait value="90"/>
	    </for>

		<!-- Disappear -->
		<perso who="loc:canon" z="28"/>
		<wait value="2"/>
		<perso who="loc:canon" z="27"/>
		<wait value="2"/>
		<remove who="loc:canon"/>
		<sound name="ZildoPousse"/>
		<perso who="loc:subHead" z="20"/>
		<wait value="2"/>
		<perso who="loc:subHead" z="19"/>
		<wait value="2"/>
		<remove who="loc:subHead"/>
		<perso who="loc:subSubHead" z="18"/>
		<wait value="2"/>
		<perso who="loc:subSubHead" z="17"/>
		<wait value="2"/>
		<remove who="loc:subSubHead"/>
						
		<perso who="loc:turretOut" alphaA="-0.1"/>
		<animation type="BREAKING_ROCK" pos="x-12,y-4"/>
		<wait value="1"/>
		<animation type="BREAKING_ROCK" pos="x,y"/>
		<wait value="2"/>
		<animation type="BREAKING_ROCK" pos="x+10,y+6"/>
		<actions>
			<remove who="loc:turretOut"/>
			<!-- Underground ==> back immaterial -->
			<perso who="self" alpha="128" flag="9" alphaA="0" alphaV="0" addSpr="0"/>
		    <visible who="self" value="true"/>		    
		</actions>
		<wait value="30"/>
		<var name="BOSS_turret_phase" value="2"/>

	</persoAction>

	<scene id="spawnBossTurret1">
	    <!-- Create turrets (turret0 is just the father of all, but invisible)-->
	    <spawn who="turret0" pos="0,0" type="TURRET" alpha="0"/>
        <spawn who="turret1" pos="110,100" type="TURRET" info="ENEMY" alpha="128"/>
        <spawn who="turret2" pos="210,100" type="TURRET" info="ENEMY" alpha="128" reverse="128"/>
        <spawn who="turret3" pos="110,180" type="TURRET" info="ENEMY" alpha="128" reverse="64"/>
	    <spawn who="turret4" pos="210,180" type="TURRET" info="ENEMY" alpha="128" reverse="192"/>
		<spawn who="turretH" pos="160,125" type="TURRET_HEART" info="ENEMY" alpha="128" addSpr="1"/>
		<!-- Link them (to avoid collision between different parts)-->
		<!-- turret0 permits us to avoid setting alpha/visible to impact everyone -->
		<perso who="turret1" parent="turret0" pv="-1"/>
	    <perso who="turret2" parent="turret0" pv="-1"/>
        <perso who="turret3" parent="turret0" pv="-1"/>
	    <perso who="turret4" parent="turret0" pv="-1"/>
       	<perso who="turretH" parent="turret0" pv="10"/>	<!-- Hero must hit 5 times (2*5 = 10) -->
       	<!--  Declare turret IMMATERIAL because it's underground -->
       	<actions>
		    <perso who="turret1" flag="9"/>
		    <perso who="turret2" flag="9"/>
   		    <perso who="turret3" flag="9"/>
   		    <perso who="turret4" flag="9"/>
   		    <perso who="turretH" flag="9"/>
   		</actions>
   		<var name="bossFighting" value="1"/>
		<!-- Cycles -->
		<loop>
			<exec script="turretCycle(210, 160, 110, 160, 210, 110, 110, 110)"/>
			<exec script="turretCycle(160, 105, 130, 135, 190, 135, 160, 165)"/>
			<exec script="turretCycle(250, 100, 160, 180, 155, 80, 65, 150)"/>
		</loop>
	</scene>
	
	<scene id="turretCycle">
		<!-- Cycle -->
		<!-- 0/3 : move under ground-->
		<var name="BOSS_turret_phase" value="0"/>
		<perso who="turret1" action="bossTurret(loc:arg0, loc:arg1, 0, 0)"/>
		<perso who="turret2" action="bossTurret(loc:arg2, loc:arg3, 1, 0)"/>
	    <perso who="turret3" action="bossTurret(loc:arg4, loc:arg5, 0, 1)"/>
		<perso who="turret4" action="bossTurret(loc:arg6, loc:arg7, 1, 1)"/>
		<loop when="BOSS_turret_phase!=1">
			<wait value="10"/>
		</loop>
		<!-- 1/3 : make vulnerable part out of the ground -->
		<perso who="turretH" alphaA="0.1"/>
		<wait value="20"/>
		<!--  Stop IMMATERIAL for turret heart -->
	    <perso who="turretH" flag="0"/>
		<animation type="BREAKING_ROCK" pos="150,125"/>
		<animation type="BREAKING_ROCK" pos="165,128"/>
		<perso who="turretH" addSpr="0"/>
	    
		<!-- Wait for turret finishing its shoot -->
		<loop when="BOSS_turret_phase!=2">
			<wait value="10"/>
		</loop>
		<!-- 2/3 : Vulnerable part crouch back -->
	    <perso who="turretH" flag="1"/> <!-- IMMATERIAL again -->
		<animation type="BREAKING_ROCK" pos="160,125"/>
		<wait value="4"/>
		<perso who="turretH" addSpr="1" alpha="128"/>
		<!-- End of cycle -->
	</scene>

	<scene id="prison15_launch1">
        <timer each="60">
            <action>
                <sound name="FlecheTir"/>
	        	<spawn type="STAFF_POUM" pos="129,156" shadow="SHADOW_SMALL" z="4" vz="0.2" az="-0.005" vx="2.3"/>
            </action>
            <exit when="zildo.y > 192 | zildo.y &lt; 100">
        		<markQuest name="prison15_trigger1Launch1" value="false"/>
        		<markQuest name="prison15_trigger2Launch1" value="false"/>
			</exit>
        </timer>
	</scene>
	
	<scene id="prison15_launch2">
        <timer each="60">
            <action>
                <sound name="FlecheTir"/>
	        	<spawn type="STAFF_POUM" reverse="128" pos="350,285" shadow="SHADOW_SMALL" z="4" vz="0.29" az="-0.005" vx="-2.3"/>
            </action>
            <exit when="zildo.y > 320 | zildo.y &lt; 228">
        		<markQuest name="prison15_trigger1Launch2" value="false"/>
        		<markQuest name="prison15_trigger2Launch2" value="false"/>
			</exit>
        </timer>
	</scene>
	
	<scene id="prison15_launch3">
        <timer each="60">
            <action>
                <sound name="FlecheTir"/>
	        	<spawn type="STAFF_POUM" pos="42,476" shadow="SHADOW_SMALL" z="4" vz="0.2" az="-0.005" vx="2.3"/>
	        	<wait value="20"/>
                <sound name="FlecheTir"/>
	        	<spawn type="STAFF_POUM" reverse="128" pos="323,476" shadow="SHADOW_SMALL" z="4" vz="0.2" az="-0.005" vx="-2.3"/>
        	</action>
            <exit when="zildo.y > 512 | zildo.y &lt; 421">
        		<markQuest name="prison15_trigger1Launch3" value="false"/>
        		<markQuest name="prison15_trigger2Launch3" value="false"/>
			</exit>
        </timer>
	</scene>
	
	<scene id="prison15_launch4">
        <timer each="60">
            <action>
                <sound name="FlecheTir"/>
	        	<spawn type="STAFF_POUM" reverse="128" pos="515,620" shadow="SHADOW_SMALL" z="4" vz="0.27" az="-0.005" vx="-3"/>
	        	<wait value="10"/>
	        	<sound name="FlecheTir"/>
	        	<spawn type="STAFF_POUM" pos="42,620" shadow="SHADOW_SMALL" z="4" vz="0.2" az="-0.005" vx="2.3"/>
        	</action>
            <exit when="zildo.y > 656 | zildo.y &lt; 575">
        		<markQuest name="prison15_trigger1Launch4" value="false"/>
        		<markQuest name="prison15_trigger2Launch4" value="false"/>
			</exit>
        </timer>
	</scene>

	<scene id="meetingKingPrison">
	    <moveTo who="zildo" pos="55,80"/>
	    <music name=""/>
	    <wait value="30"/>
	    <speak who="zildo" text="prison.saveKing.zildo.0"/>
	    <moveTo who="zildo" pos="229,80" unblock="true"/>
	    <wait value="60"/>
	    <seq who="king" addSpr="1,0,1,0" wait="20"/>
   	    <speak who="king" text="prison.saveKing.trion.0" unblock="true"/>
	    <seq who="king" addSpr="1,2" wait="20"/>
	    <wait value="130"/>
	    <speak who="king" text="prison.saveKing.trion.1"/>
	    <speak who="zildo" text="prison.saveKing.zildo.1"/>
	    <speak who="king" text="prison.saveKing.trion.2"/>
   	    <!-- Back to the music -->
	    <music name="Chateau"/>
   	</scene>
   	
	<scene id="meetingKingPrisonSuite">
	    <speak who="king" text="prison.saveKing.trion.3"/>
	    <angle who="zildo" value="1"/>
   	    <if expQuest="killKingGuards">
   	        <speak who="zildo" text="prison.saveKing.zildo.b3"/>
			<speak who="king" text="prison.saveKing.trion.b4"/>
			
			<!--  king exposes his illness -->
			<speak who="king" text="prison.saveKing.trion.ill.1"/>
			<speak who="king" text="prison.saveKing.trion.ill.2"/>
			<speak who="king" text="prison.saveKing.trion.ill.3"/>
   	        <speak who="zildo" text="prison.saveKing.zildo.2"/>
			<speak who="king" text="prison.saveKing.trion.ill.4"/>
   	        <speak who="zildo" text="prison.saveKing.zildo.3"/>
   	        <speak who="king" text="prison.saveKing.trion.ill.5"/>
   	        <speak who="king" text="prison.saveKing.trion.ill.6"/>
   	        <speak who="zildo" text="prison.saveKing.zildo.4"/>
			<moveTo who="zildo" pos="208,152"/>
   	    </if>
   	    <if expQuest="!killKingGuards">
   	        <speak who="zildo" text="prison.saveKing.zildo.a1"/>
			<speak who="king" text="prison.saveKing.trion.a4"/>
			<speak who="zildo" text="prison.saveKing.zildo.a2"/>
			<moveTo who="zildo" pos="208,152"/>
			<markQuest name="metKingPrison2" value="false"/>
	    </if>
   	</scene>
   	
	<scene id="meetingKingPrisonIllness">
	    <speak who="king" text="prison.saveKing.trion.ill.7"/>
	    <if expQuest="!itemCUREPOTION">
	        <speak who="zildo" text="prison.saveKing.zildo.5"/>
	        <speak who="king" text="prison.saveKing.trion.ill.6"/>
	        <speak who="zildo" text="prison.saveKing.zildo.4"/>

    		<moveTo who="zildo" pos="208,152"/>
			<markQuest name="metKingPrison3" value="false"/>
	    </if>
	    <if expQuest="itemCUREPOTION">
	        <!-- Hero brought the cure potion -->
	        <speak who="zildo" text="prison.saveKing.zildo.6"/>
	        <putDown item="CUREPOTION"/>
       	    <perso who="king" addSpr="1"/>
	        <moveTo who="zildo" pos="234,70"/>
       	    <wait value="10" />
    	    <animation pos="255,60" type="STAR_CIRCLE" />
    	    <wait value="140" />
       	    <perso who="king" addSpr="2"/>
  	        <speak who="king" text="prison.saveKing.trion.4"/>
	        <spawn who="maltus" pos="11,84" type="BANDIT_CHAPEAU" angle="1"/>
	        <actions>
	            <music/>
	        	<speak who="maltus" text="prison.saveKing.maltus.1"/>
	           	<angle who="zildo" value="3"/>
	        </actions>
	        <moveTo who="maltus" pos="206,83" unblock="true"/>
	        <speak who="maltus" text="prison.saveKing.maltus.2"/>
	        <speak who="king" text="prison.saveKing.trion.5"/>
	        <speak who="maltus" text="prison.saveKing.maltus.3"/>
	        <speak who="king" text="prison.saveKing.trion.6"/>
	        <angle who="zildo" value="1"/>
	        <wait value="20"/>
	        <speak who="zildo" text="prison.saveKing.zildo.7"/>
	        <music name="Story"/>
	        <speak who="king" text="prison.saveKing.trion.7"/>
   	        <speak who="zildo" text="prison.saveKing.zildo.8"/>
	        <speak who="king" text="prison.saveKing.trion.8"/>
	        <speak who="king" text="prison.saveKing.trion.9"/>
   	        <speak who="zildo" text="prison.saveKing.zildo.9"/>
	        <speak who="king" text="prison.saveKing.trion.10"/>
   	        <speak who="zildo" text="prison.saveKing.zildo.10"/>
	        <speak who="maltus" text="prison.saveKing.maltus.4"/>
	        <angle who="zildo" value="3"/>
   	        <wait value="60"/>
   	        <angle who="zildo" value="1"/>
	        <speak who="king" text="prison.saveKing.trion.11"/>
   	        <speak who="zildo" text="prison.saveKing.zildo.11"/>
   	        <actions>
		        <take item="DRAGON_KEY"/>
		        <animation type="STAR_SHINE" pos="240,46"/>
   	        </actions>
   	        <speak who="king" text="prison.saveKing.trion.12"/>
		    <animation type="STAR_SHINE" pos="237,49"/>
   	        <speak who="king" text="prison.saveKing.trion.13"/>
	        <speak who="king" text="prison.saveKing.trion.14"/>
	        <actions>
			    <speak who="maltus" text="prison.saveKing.maltus.5"/>
			    <moveTo who="maltus" pos="4,0" delta="true"/>
	        </actions>
	        <wait value="50"/>
	        <fadeOut type="0"/>
	        <wait value="50"/>
	        <music />
	        <wait value="50"/>
	        <script who="zildo" text="VIDE"/>
	        <map name="prisonext"/>
	        <pos who="zildo" pos="743,192"/>
	        <fadeIn type="0" unblock="true"/>
	        <moveTo who="zildo" speed="0.5" pos="0,32" delta="true"/>
	        <speak who="zildo" text="prison.saveKing.zildo.12"/>
	        <speak who="zildo" text="prison.saveKing.zildo.13"/>
	        <music name="Chateau"/>
   	    </if>
	</scene>
	
	<scene id="vactoComeIn">
  	    <sound name="MenuMove"/><wait value="15"/>
       	<sound name="MenuMove"/><wait value="15"/>
    	<sound name="MenuMove"/><wait value="15"/>
    	<script who="eleoric" value="3"/> <!--  She stands still -->
   		<angle who="eleoric" value="2"/>
   		<speak who="eleoric" text="eleom1.e.3b"/>
   		<spawn who="vacto" type="VACTO" pos="161,219" alpha="0" alphaA="2"/>
   		<sound name="OuvrePorte"/>
   		<wait value="80"/>
   		<actions>
	   		<moveTo who="vacto" pos="161,135"/>
   			<speak who="vacto" text="eleom1.vacto.0"/>"
   		</actions>
   		<angle who="eleoric" value="1"/>
   		<!-- She introduces Vacto to hero -->
   		<speak who="eleoric" text="eleom1.e.4"/>
   		<script who="vacto" value="2" effect="zildo"/>
   		<script who="zildo" value="2" effect="vacto"/>
   		<wait value="20"/>
   		<speak who="vacto" text="eleom1.vacto.1"/>
   		<spawn what="bag" pos="161,113" type="EMPTY_BAG"/>
   		<sound name="ZildoAtterit"/>
   		<wait value="20"/>
   		<script who="vacto" value="3"/>
   		<script who="zildo" value="3"/>
   		<angle who="vacto" value="3"/>
   		<moveTo who="eleoric" pos="117,98"/>
   		<speak who="eleoric" text="eleom1.e.5"/>
   		<angle who="vacto" value="3"/>
   		<speak who="vacto" text="eleom1.vacto.2"/>
   		<speak who="eleoric" text="eleom1.e.6"/>
   		<speak who="eleoric" text="eleom1.e.7"/>
   		<speak who="vacto" text="eleom1.vacto.3"/>
   		<moveTo who="vacto" pos="161,219"/>
   		<perso who="vacto" alphaA="-2"/>
   		<wait value="30"/>
   		<remove who="vacto"/>
   		<moveTo who="eleoric" pos="88,80"/>
   		<script who="eleoric" value="0" effect="2"/>
	</scene>
	
	<scene id="EleoPrepareAntidote">
	    <music name=""/>
	    <script who="eleoric" value="3"/>
	    <moveTo who="eleoric" pos="88,58"/>
	    <angle who="eleoric" value="0"/>
	    <wait value="80"/>
	    <for var="loc:j" value="2">
		    <for var="loc:i" value="3">
			    <sound name="PeebleFloor"/>
			    <wait value="8"/>
		    	<spawn type="GREEN_BUBBLE" pos="85+7*random,39" light="#2255bb"
		    	    vz="0.1" z="4" alphaA="-0.1" foreground="true" zoom="240"/>
	   	    </for>
	   	    <spawn impact="STAR_YELLOW" pos="85+7*random,39" vy="-0.4" vx="-0.5+random" alphaA="-1"/>
		    <wait value="20"/>
	   	    <spawn impact="STAR_YELLOW" pos="85+7*random,39" vy="-0.4" vx="-0.5+random" alphaA="-1"/>
	    	<spawn type="GREEN_BUBBLE" pos="85+7*random,39" light="#ff55aa"
	    	    vz="0.1" z="4" alphaA="-0.1" foreground="true" zoom="250"/>
	   	    <sound name="LavaDrop"/>
		    <for var="loc:i" value="4">
			    <sound name="PeebleFloor"/>
			    <wait value="9"/>
		    	<spawn type="GREEN_BUBBLE" pos="85+7*random,39" light="#66ff33"
		    	    vz="0.1" z="4" alphaA="-0.1" foreground="true" zoom="240"/>
	   	    </for>
	   	    <spawn impact="STAR_YELLOW" pos="85+7*random,39" vy="-0.4" vx="-0.5+random" alphaA="-1"/>
	   	   	<sound name="LavaDrop"/>
	   	   	<wait value="30"/>
	   	    <sound name="LavaDrop"/>
	    </for>
	    <speak who="eleoric" text="eleom1.e.13"/>
	    <angle who="eleoric" value="2"/>
	    <speak who="eleoric" text="eleom1.e.14"/>
	    <markQuest name="antidotePrepared" value="true"/>
   	</scene>

	<scene id="discoverNatureRuin">
    	<wait value="50"/>
    	<angle who="zildo" value="0"/>
    	<wait value="20"/>
    	<moveTo what="camera" pos="0,-32" delta="true"/>
    	<speak who="zildo" text="sousbois4.roxy.scene.0"/>
    	<speak who="zildo" text="sousbois4.roxy.scene.1"/>
    	<moveTo what="camera" pos="0,32" delta="true"/>
	</scene>	
	<!-- Many random explosions on given character and hide him at the middle of the show -->
	<!-- Zildo doesn't take damage from it -->
	<persoAction id="explodeBoss">
	    <for var="loc:i" value="10">
			<spawn impact="EXPLOSION_UNDAMAGE" pos="x-10+random*20,y-10 + random*20"/>
			<wait value="2"/> 
	    </for>
	    <visible who="self" value="false"/>
	    <for var="loc:i" value="10">
			<spawn impact="EXPLOSION_UNDAMAGE" pos="x-10+random*20,y-10 + random*20"/>
			<wait value="2"/> 
	    </for>
   	</persoAction>
   	
	<persoAction id="explodeBigBoss">
	    <for var="loc:i" value="30">
			<spawn impact="EXPLOSION_UNDAMAGE" pos="x-10+random*20 + loc:arg0,y-10 + loc:arg1 + random*70"/>
			<wait value="2"/> 
	    </for>
	    <visible who="self" value="false"/>
	    <for var="loc:i" value="20">
			<spawn impact="EXPLOSION_UNDAMAGE" pos="x-10+random*20 + loc:arg0,y-10 + loc:arg1 + random*70"/>
			<wait value="2"/> 
	    </for>
   	</persoAction>
	
	<!-- Green bubble coming out of a cauldron -->
	<tileAction id="bubbleCauldron">
		<timer each="25+45*random">
	    	<action>
		    	<spawn type="GREEN_BUBBLE" pos="x*16+5+7*random,y*16+7" 
		    	    vz="0.1" z="4" alphaA="-0.1" foreground="true" zoom="254+dice10/5"/>
	    	</action>
		</timer>
	</tileAction>
	
	<!-- fire elemental -->
	<persoAction id="elemBehav">
	    <loop>
   			<var name="loc:found" value="0"/>
   			<!-- Look for hero around him -->
   	        <lookFor who="self" info="ZILDO" sight="true" radius="6">
				<var name="loc:found" value="1"/>
	        </lookFor>
			<if exp="loc:found=1">
			    <!-- Blink and get to life -->
			    <sound name="MenuSelectGame"/>
			    <for var="loc:i" value="5">
			        <seq who="self" addSpr="0,1" wait="0"/>
			    </for>
				<perso who="self" addSpr="2"/>
			    <wait value="20"/>
			    <perso who="self" addSpr="3"/>
			    <wait value="10"/>
			    <!-- Attract hero to the elemental -->
			    <var name="loc:seq" value="0"/>
			    <sound name="Wind"/>
			    <loop when="loc:found=1">
				    <var name="loc:deltaX" value="x-zildo.x"/>
				    <var name="loc:deltaY" value="y-zildo.y"/>
	   			    <perso who="zildo" vx="loc:deltaX/70" vy="loc:deltaY/70"/>
	   			    	   			    
	   			    <for var="loc:j" value="5">
		   			    <var name="loc:seq" value="(loc:seq+1) % 3"/>
		   			    <exec script="suckOut(x,y,loc:seq)"/>
   	   			    </for>
	   			   	<!-- If hero is out of sight, stop sucking out and declare it -->		    	   			    	   			    	   			    
				    <lookFor who="self" info="ZILDO" sight="true" radius="6" negative="true">
						<var name="loc:found" value="0"/>
			        </lookFor>
   			    </loop>
   			    <sound name="Wind" mute="true"/>
	   	        <wait value="20"/>
   			    <perso who="zildo" vx="0" vy="0"/>
		        <!-- Hero is out of sight, elemental rest in peace -->
		        <sound name="ElementalSleep"/>
   				<perso who="self" addSpr="2"/>
			    <wait value="20"/>
			    <perso who="self" addSpr="1"/>
			    <wait value="10"/>
			    <perso who="self" addSpr="0"/>
    		</if>
		    <wait value="5"/>
	    </loop>
	</persoAction>
	
	<!-- Blow wind sprites in 6 directions under fire elemental -->
	<scene id="suckOut"> <!-- Arguments: x,y, seq (=position in sprite sequence [0..2] -->
	    <actions>
		    <if exp="loc:arg2 = 0">
		        <actions>
				    <spawn what="loc:air" type="FIREWIND1" pos="loc:arg0-3-6,loc:arg1+2+8" alpha="130+80*random" alphaA="-1" vx="1" fx="0.1" fz="0.1" vz="8/6" z="6"/>
			    	<spawn what="loc:air2" type="FIREWIND1" pos="loc:arg0+3+6,loc:arg1+2+8" alpha="130+80*random" alphaA="-1" vx="-1" fx="0.1" fz="0.1" vz="8/6" z="6" reverse="128"/>
		        </actions>
			</if>
		    <if exp="loc:arg2 = 1">
		        <actions>
	     	   		<spawn what="loc:air" type="FIREWIND2" pos="loc:arg0+1-4,loc:arg1+2+12" alpha="130+80*random" alphaA="-1" vx="2/3" fx="0.1" fz="0.1" vz="2" z="3"/>
				    <spawn what="loc:air2" type="FIREWIND2" pos="loc:arg0+1+4,loc:arg1+2+12" alpha="130+80*random" alphaA="-1" vx="-2/3" fx="0.1" fz="0.1" vz="2" z="3" reverse="128"/>
				</actions>
		   	</if>
		    <if exp="loc:arg2 = 2">
		        <actions>
			    	<spawn what="loc:air" type="FIREWIND3" pos="loc:arg0-1-2,loc:arg1+2+20" alpha="130+80*random" alphaA="-1" vx="1/3" fx="0.1" fz="0.1" vz="15/6" z="3"/>
			    	<spawn what="loc:air2" type="FIREWIND3" pos="loc:arg0+1+2,loc:arg1+2+20" alpha="130+80*random" alphaA="-1" vx="-1/3" fx="0.1" fz="0.1" vz="15/6" z="3" reverse="128"/>
		        </actions>
		    </if>
	    </actions>
   	</scene>
   	
	<!-- Scene with 2 parameters: (x,y) of the map tile containg the lever -->
	<scene id="activeLever">
	    <sound name="Switch"/>
	    <tile pos="loc:arg0,loc:arg1" back2="128+256*10"/>
	    <wait value="5"/>
	    <tile pos="loc:arg0,loc:arg1" back2="135+256*10"/>
	</scene>

	<scene id="resetLever">
	    <sound name="Switch"/>
	    <tile pos="loc:arg0,loc:arg1" back2="128+256*10"/>
	    <wait value="5"/>
	    <tile pos="loc:arg0,loc:arg1" back2="127+256*10"/>
	</scene>
	
	<persoAction id="bossDragon">
        <var name="dragonPos" value="2"/>
	    <loop>
		    <for var="loc:j" value="2">
			    <sound name="SerpentSpit"/>
			    <!-- Save dragon location, because in 'lookFor' block, x and y vars means hero's location -->
			    <var name="loc:dragonX" value="x"/>
			    <var name="loc:dragonY" value="y"/>
			    <script who="self" value="19"/>
   				<lookFor who="self" info="ZILDO" radius="18">
   	   	            <for var="loc:i" value="5">
	   	                <!-- Fireball are reversed accordingly to their target, in Java ActionExecutor#render-->
					    <throw who="dragon" pos="loc:dragonX, loc:dragonY-60" to="zildo.x,zildo.y" speed="1.8" floor="2"
						      		 	   type="FIRE_BALL" zoom="127" foreground="true"/>
	   				    <wait value="3"/>
		            </for>
   				</lookFor>
   	            <script who="self" value="3"/>
	            <wait value="140"/>
	            
	            <!-- Check if dragon has to move -->
	            <if expQuest="dragonShouldMove1">
	                <if exp="dragonPos!=1">
		                <markQuest name="dragonShouldMove2" value="false"/>
		                <markQuest name="dragonShouldMove3" value="false"/>
		                <markQuest name="dragonShouldMove4" value="false"/>
		                <markQuest name="dragonShouldMove5" value="false"/>
   		               	<exec script="dragonDiveAndReappear(230,567)"/>
		                <var name="dragonPos" value="1"/>
	                </if>
	            </if>
	            <if expQuest="dragonShouldMove2">
	                <if exp="dragonPos!=2">
		                <markQuest name="dragonShouldMove1" value="false"/>
		                <markQuest name="dragonShouldMove3" value="false"/>
		                <markQuest name="dragonShouldMove4" value="false"/>
		                <markQuest name="dragonShouldMove5" value="false"/>
   		                <exec script="dragonDiveAndReappear(451,394)"/>
		                <var name="dragonPos" value="2"/>
   	                </if>
	            </if>
	           	<if expQuest="dragonShouldMove3">
	                <if exp="dragonPos!=3">
		                <var name="dragonPos" value="3"/>
		                <markQuest name="dragonShouldMove1" value="false"/>
		                <markQuest name="dragonShouldMove2" value="false"/>
		                <markQuest name="dragonShouldMove4" value="false"/>
		                <markQuest name="dragonShouldMove5" value="false"/>
		             	<exec script="dragonDiveAndReappear(724,410)"/>
	                </if>
	            </if>
	            <if expQuest="dragonShouldMove4">
	                <if exp="dragonPos!=4">
		                <markQuest name="dragonShouldMove1" value="false"/>
		                <markQuest name="dragonShouldMove2" value="false"/>
		                <markQuest name="dragonShouldMove3" value="false"/>
		                <markQuest name="dragonShouldMove5" value="false"/>
   		                <exec script="dragonDiveAndReappear(215,280)"/>
		                <var name="dragonPos" value="4"/>
   	                </if>
	            </if>
	            <if expQuest="dragonShouldMove5">
	                <if exp="dragonPos!=5">
		                <markQuest name="dragonShouldMove1" value="false"/>
		                <markQuest name="dragonShouldMove2" value="false"/>
		                <markQuest name="dragonShouldMove3" value="false"/>
		                <markQuest name="dragonShouldMove4" value="false"/>
   		                <exec script="dragonDiveAndReappear(720,697)"/> <!--  736 -->
		                <var name="dragonPos" value="5"/>
	                </if>
	            </if>
   	   	    </for>
	    </loop>
   	</persoAction>
   	
	<!-- Parameters: newLocation=(arg0, arg1) -->
	<scene id="dragonDiveAndReappear">
    	<!-- Maybe blow smoke before diving ? -->
   	    <perso who="dragon" az="-0.01"/>
   	    <wait value="40"/>
   	    <perso who="dragon" az="-0.02"/>
   	    <wait value="20"/>
   	    <script who="dragon" value="20"/>	<!-- Retract arms -->
   	    <wait value="150"/>
   	    <perso who="dragon" alpha="255" vz="0" az="0.02" z="-150"/>	<!-- Lift up -->
   	    <pos who="dragon" pos="loc:arg0,loc:arg1"/>
   	    <wait value="80"/>
   	    <perso who="dragon" az="0.01"/>
   	    <wait value="15"/>
   	    <script who="dragon" value="3"/>
   	    <wait value="20"/>
   	    <perso who="dragon" z="0" az="0" vz="0"/>
	</scene>
			
	<scene id="heroMeetDragon">
	    <script who="zildo" text="VIDE"/>
	    <speak what="zildo" text="cavef8.beforeDragon"/>
	    <script who="zildo" value="0"/>
	    <music/>
	    <wait value="50"/>
	    <moveTo who="zildo" pos="0,24" delta="true" speed="0.5" unblock="true"/>
	    <wait value="10"/>
	    <fadeOut type="0"/>
	    <wait value="100"/>
	    <map name="dragon"/>
	    <pos who="dragon" pos="230,567"/>
	    <pos who="zildo" pos="496,23"/>
	    <fadeIn type="0"/>
	    <moveTo who="zildo" pos="0,64" delta="true"/>
	    <wait value="30"/>
	    <moveTo who="zildo" pos="496,125" speed="1.5"/>
	    <wait value="20"/>
	    <angle who="zildo" value="3"/>
	    <wait value="30"/>
	    <angle who="zildo" value="1"/>
	    <wait value="20"/>
	    <angle who="zildo" value="2"/>
	    <wait value="30"/>
	    <moveTo who="zildo" pos="496,205" unstoppable="true"/>
	    <music name="Voleurs"/>
	    <sound name="ZildoPousse"/>
	    <filter type="4"/>
	    <wait value="20"/>
	    <sound name="ZildoPousse"/>
	    <filter type="0"/>
	    <!-- Start earthquake -->
	    <filter type="5"/>
	    <spawn type="STONE_HEAVY" pos="450,185" z="80" az="-0.1"/>
	    <wait value="20"/>
	    <sound name="BigRat"/>
	    <spawn type="STONE_HEAVY" pos="598,124" z="90" az="-0.1"/>
	    <wait value="5"/>
	    <spawn type="STONE_HEAVY" pos="467,116" z="80" az="-0.1"/>
	    <tile pos="0,0" action="makeCloudsDragon"/>
	    <tile pos="0,0" action="fallRocks"/>
	    <wait value="5"/>
	    <spawn type="STONE_HEAVY" pos="496,195" z="80" az="-0.1"/> <!-- Rock falls on hero -->
	    <sound name="BigRat"/>
	    <moveTo who="zildo" pos="-40,12" speed="2.2" delta="true"/>
	    <angle who="zildo" value="0"/>
	    <wait value="20"/>
	    <moveTo who="zildo" pos="0,16" speed="0.8" delta="true" backward="true"/>
	     
	    <wait value="50"/>
	    <!-- Remove the first rock platform, to block hero's exit -->
	    <actions>
		    <spawn type="SMOKE" pos="497,116" zoom="800" alphaA="-0.1"/>
		    <spawn type="SMOKE" pos="457,126" zoom="810" alphaA="-0.1"/>
		    <spawn type="SMOKE" pos="527,130" zoom="830" alphaA="-0.1"/>
		    <spawn type="SMOKE" pos="500,150" zoom="850" alphaA="-0.1"/>
	    </actions>
	     
	    <!-- Remove platform -->
	    <for var="loc:j" value="3">
		  	<for var="loc:i" value="6">
		    	<tile pos="28+loc:i,6+loc:j" back="256*10 + 34" back2="-1"/>
		  	</for>
     	</for>
	    <actions>
	    	<tile pos="28,9" back2="-1"/>
			<tile pos="29,9" back2="-1"/>
			<tile pos="30,9" back="256*10+34"/>
			<tile pos="31,9" back="256*10+34"/>
			<tile pos="32,9" back2="-1"/>
			<tile pos="33,9" back2="-1"/>
		</actions>
		<angle who="zildo" value="3"/>
		<tile pos="28,6" action="lavaBubbles"/>
	    <var name="dragonPos" value="4"/>
	    <filter type="0"/>
		<angle who="zildo" value="0"/>
	    <exec script="dragonDiveAndReappear(215,280)"/>
		<angle who="zildo" value="3"/>
	    <perso who="dragon" action="bossDragon"/>
	    
	    <var name="bossFighting" value="1"/>
	</scene>
	
	<scene id="ep3_closure">
	    <speak what="camera" text="ep3.end.0"/>
	    <music name="Triste"/>
	    <speak what="camera" text="ep3.end.1"/>
	    <fadeOut value="0"/>
	    <speak what="camera" text="ep3.end.2"/>
	    <if expQuest="vactoChrista">
		    <speak what="camera" text="ep3.end.2b"/>
	    </if>
   	    <speak what="camera" text="ep3.end.3"/>
	    <speak what="camera" text="ep3.end.4"/>
	    <!-- closure -->
   	    <speak what="camera" text="ep3.end.5"/>
  	    <speak what="camera" text="ep2.ending.cut.1"/>
	   	<end type="0"/>
  	    
  	    <!-- episode 4 ready
  	   	<exec script="intro_episode4"/>
  	   	-->
	</scene>
	
	<tileAction id="fountain">
	    <var name="loc:a" value="1" />
	    <timer each="1+random*1">
	        <action>
		        <spawn type="DROP_SMALL" pos="x*16,y*16+12" vx="random*0.6-0.3" vy="random*2-1" z="4" vz="2.4" az="-0.1" alpha="255" alphaA="-0.3"/>
	        </action>
   	    </timer>
	</tileAction>
</adventure>